import os
import json
import time
import datetime
import re
import random
import zipfile
import io
import sqlite3
import smtplib
import math
import asyncio
from contextlib import contextmanager
from typing import List, Optional, Dict, Any
from enum import Enum
from pydantic import BaseModel, Field, ConfigDict
from email.mime.multipart import MIMEMultipart
from email.mime.base import MIMEBase
from email import encoders
from google import genai
from google.genai import types

# ==========================================
# 0. è¨­å®š & 2026å¹´ä»•æ§˜ (Headless / Embeddingãªã—)
# ==========================================
# ç’°å¢ƒå¤‰æ•°ã‹ã‚‰å–å¾—
API_KEY = os.environ.get("GEMINI_API_KEY")
GMAIL_USER = os.environ.get("GMAIL_USER")
GMAIL_PASS = os.environ.get("GMAIL_PASS")
TARGET_EMAIL = os.environ.get("GMAIL_USER") 

# ãƒ¢ãƒ‡ãƒ«è¨­å®š (2026å¹´ä»•æ§˜: Gemma 3 Limits Optimized)
MODEL_ULTRALONG = "gemini-3-flash-preview"       # Gemini 3.0 Flash (ãƒ—ãƒ­ãƒƒãƒˆç”¨ãƒ»JSONå¯¾å¿œ)
MODEL_LITE = "gemma-3-12b-it"        # Gemma 3 12B (é€šå¸¸åŸ·ç­†ãƒ»JSONéå¯¾å¿œ)
MODEL_PRO = "gemma-3-27b-it"             # Gemma 3 27B (é‡è¦å›åŸ·ç­†ãƒ»JSONéå¯¾å¿œ)
MODEL_MARKETING = "gemini-2.0-flash-lite-preview-02-05" # ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°åˆ†æç”¨ (JSONå¯¾å¿œ)

DB_FILE = "factory_run.db" # è‡ªå‹•å®Ÿè¡Œç”¨ã«ä¸€æ™‚DBã¸å¤‰æ›´

# Global Config: Rate Limits
MIN_REQUEST_INTERVAL = 0.5

# ==========================================
# æ–‡ä½“å®šç¾© & ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿
# ==========================================
STYLE_DEFINITIONS = {
    "style_serious_fantasy": {
        "name": "ç„¡è·è»¢ç”Ÿé¢¨ï¼ˆç†ä¸å°½ãªå­«ã®æ‰‹ï¼‰",
        "instruction": "ã€æ–‡ä½“æ¨¡å€£: ä¼è¨˜çš„ãƒ»å†…çœçš„ã€‘\n1. åœ°ã®æ–‡ã¯ã€Œéå»ã‚’å›æƒ³ã™ã‚‹æ‰‹è¨˜ã€ã®ã‚ˆã†ãªè½ã¡ç€ã„ãŸãƒˆãƒ¼ãƒ³ã§è¨˜è¿°ã›ã‚ˆã€‚\n2. ä¸»äººå…¬ã®å¿ƒç†æå†™ã¯ã€è‡ªèº«ã®å¼±ã•ã‚„æ¬²æœ›ã‚’éš ã•ãšã€èµ¤è£¸ã€…ã«ã€ã—ã‹ã—ã©ã“ã‹å®¢è¦³çš„ã«æã‘ã€‚\n3. ä¸–ç•Œè¦³ã®èª¬æ˜ã¯ã€äº”æ„Ÿï¼ˆé£Ÿäº‹ã®å‘³ã€åœŸã®åŒ‚ã„ï¼‰ã‚’é€šã˜ã¦ç”Ÿæ´»æ„Ÿã‚’æŒãŸã›ã‚ã€‚\n4. æˆ¦é—˜æå†™ã‚ˆã‚Šã‚‚ã€ãã®çµæœã¨ã—ã¦ã®ã€Œæˆé•·ã€ã‚„ã€Œå¾Œæ‚”ã€ã«ç„¦ç‚¹ã‚’å½“ã¦ã‚ã€‚"
    },
    "style_psychological_loop": {
        "name": "ãƒªã‚¼ãƒ­é¢¨ï¼ˆé•·æœˆé”å¹³ï¼‰",
        "instruction": "ã€æ–‡ä½“æ¨¡å€£: æ„Ÿæƒ…çˆ†ç™ºãƒ»å¿ƒç†æ¥µåœ°ã€‘\n1. çµ¶æœ›çš„ãªçŠ¶æ³ã§ã¯ã€æ¯ç¶™ãã®ã§ããªã„ã‚ˆã†ãªé•·æ–‡ã¨ã€ç•³ã¿æ›ã‘ã‚‹ã‚ˆã†ãªçŸ­æ–‡ã‚’ç¹”ã‚Šäº¤ãœã‚ã€‚\n2. ã€Œâ€•â€•ãƒƒï¼ã€ã‚„ã€Œãã€ã‚â€¦â€¦ã€ã¨ã„ã£ãŸã€è¨€è‘‰ã«ãªã‚‰ãªã„æ‚²é³´ã‚„å‘¼å¸éŸ³ã‚’å¤šç”¨ã›ã‚ˆã€‚\n3. å¿ƒç†æå†™ã¯ã€è‡ªå·±å«Œæ‚ªã¨ä»–è€…ã¸ã®åŸ·ç€ã‚’ã€ç²˜ç€è³ªã«ã€åŸ·æ‹—ã«ç¹°ã‚Šè¿”ã›ã€‚\n4. ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®ã‚»ãƒªãƒ•ã¯æ„Ÿæƒ…å…¨é–‹ã§ã€å«ã³ã€æ³£ãã€æ‡‡é¡˜ã™ã‚‹ãƒˆãƒ¼ãƒ³ã‚’ç¶­æŒã›ã‚ˆã€‚"
    },
    "style_military_rational": {
        "name": "å¹¼å¥³æˆ¦è¨˜é¢¨ï¼ˆã‚«ãƒ«ãƒ­ãƒ»ã‚¼ãƒ³ï¼‰",
        "instruction": "ã€æ–‡ä½“æ¨¡å€£: åˆç†çš„ãƒ»è«–ç†çš„ã€‘\n1. èªå½™ã¯æ¥µã‚ã¦ç¡¬è³ªã«ã€‚ã€Œèªè­˜ã€ã€Œæœ€é©åŒ–ã€ã€Œè²»ç”¨å¯¾åŠ¹æœã€ãªã©ã®ç†Ÿèªã‚’å¤šç”¨ã›ã‚ˆã€‚\n2. åœ°ã®æ–‡ã¯ã€æ„Ÿæƒ…ã‚’æ’ã—ãŸã€Œå ±å‘Šæ›¸ã€ã‚„ã€Œè«–æ–‡ã€ã®ã‚ˆã†ãªãƒ‰ãƒ©ã‚¤ãªæ–‡ä½“ã‚’ç¶­æŒã›ã‚ˆã€‚\n3. ç¥ã‚„é‹å‘½ã‚’å†·ç¬‘ã—ã€ç‰©ç†æ³•å‰‡ã¨çµŒæ¸ˆåˆç†æ€§ã®ã¿ã‚’ä¿¡ã˜ã‚‹è¦–ç‚¹ã‚’è²«ã‘ã€‚\n4. ã‚«ã‚¿ã‚«ãƒŠèªï¼ˆã‚·ã‚«ã‚´å­¦æ´¾ã€ãƒ‰ã‚¯ãƒˆãƒªãƒ³ç­‰ï¼‰ã‚’æ¼¢å­—ã®ä¸­ã«æ··ãœã€ã‚¤ãƒ³ãƒ†ãƒªã‚¸ã‚§ãƒ³ã‚¹ãªé›°å›²æ°—ã‚’é†¸æˆã›ã‚ˆã€‚"
    },
    "style_magic_engineering": {
        "name": "é­”æ³•ç§‘é¢¨ï¼ˆä½å³¶å‹¤ï¼‰",
        "instruction": "ã€æ–‡ä½“æ¨¡å€£: è¨­å®šè³‡æ–™ãƒ»è§£èª¬çš„ã€‘\n1. ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚·ãƒ¼ãƒ³ã§ã‚ã£ã¦ã‚‚ã€ã€Œç¾è±¡ã®ç‰©ç†çš„ãƒ»é­”æ³•çš„ãªãƒ¡ã‚«ãƒ‹ã‚ºãƒ ã€ã‚’è©³ç´°ã«è§£èª¬ã›ã‚ˆã€‚\n2. æ„Ÿæƒ…ã‚ˆã‚Šã‚‚ã€Œäº‹è±¡ã€ã‚’å„ªå…ˆã—ã€é­”æ³•ã®ç™ºå‹•ãƒ—ãƒ­ã‚»ã‚¹ï¼ˆCADã€èµ·å‹•å¼ã€äº‹è±¡æ”¹å¤‰ï¼‰ã‚’è«–ç†çš„ã«è¨˜è¿°ã›ã‚ˆã€‚\n3. ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆã‚„æ”¹è¡Œã‚’æ•´ç„¶ã¨ã—ã€èª¬æ˜æ–‡ã®ã‚ˆã†ãªèª­ã¿ã‚„ã™ã•ã‚’æ„è­˜ã›ã‚ˆã€‚\n4. ä¸»äººå…¬ã¯å¸¸ã«å†·é™ã§ã€å‘¨å›²ã®é©šãã‚’ã‚ˆãã«æ·¡ã€…ã¨æœ€é©è§£ã‚’å®Ÿè¡Œã•ã›ã‚ã€‚"
    },
    "style_comedy_speed": {
        "name": "ã“ã®ã™ã°é¢¨ï¼ˆæšãªã¤ã‚ï¼‰",
        "instruction": "ã€æ–‡ä½“æ¨¡å€£: è»½å¿«ãƒ»æ¼«æ‰ã€‘\n1. åœ°ã®æ–‡ã¯æœ€å°é™ã«ã—ã€ã‚»ãƒªãƒ•ã®æ›ã‘åˆã„ï¼ˆãƒ†ãƒ³ãƒï¼‰ã§ç‰©èªã‚’é€²è¡Œã•ã›ã‚ˆã€‚\n2. ä¸»äººå…¬ã®ãƒ„ãƒƒã‚³ãƒŸã¯é‹­ãã€ã‹ã¤æƒ…ã‘ãªãã€‚ã€ŒãŠã„å¾…ã¦ã€ã€Œãµã–ã‘ã‚“ãªã€ç­‰ã®å£èªä½“ã‚’åœ°ã®æ–‡ã«ã‚‚æ··ãœã‚ã€‚\n3. ã‚·ãƒªã‚¢ã‚¹ãªé›°å›²æ°—ã¯3è¡Œä»¥ä¸Šç¶šã‘ã‚‹ãªã€‚å¿…ãšã‚ªãƒã‚„å°ç„¡ã—ã«ã™ã‚‹è¦ç´ ã‚’å…¥ã‚Œã‚ã€‚\n4. æ“¬éŸ³ï¼ˆã‚«ã‚¨ãƒ«ã®é³´ãå£°ã€çˆ†è£‚éŸ³ï¼‰ã‚’ã‚³ãƒŸã‚«ãƒ«ã«è¡¨ç¾ã›ã‚ˆã€‚"
    },
    "style_overlord": {
        "name": "ã‚ªãƒãƒ­é¢¨ï¼ˆä¸¸å±±ããŒã­ï¼‰",
        "instruction": "ã€æ–‡ä½“æ¨¡å€£: è˜å³ãƒ»ã‚¢ãƒ³ã‚¸ãƒ£ãƒƒã‚·ãƒ¥ã€‘\n1. ä¸»äººå…¬ã®ç‹¬ç™½ï¼ˆå°å¿ƒè€…ï¼‰ã¨ã€å‘¨å›²ã‹ã‚‰ã®è¦–ç‚¹ï¼ˆçµ¶å¯¾çš„ãªæ”¯é…è€…ï¼‰ã®ã‚®ãƒ£ãƒƒãƒ—ã‚’å¼·èª¿ã›ã‚ˆã€‚\n2. é…ä¸‹ã®æå†™ã¯ã€å®—æ•™çš„ãªã¾ã§ã®å´‡æ‹ã¨ã€éå‰°ãªæ•¬èªã‚’ç”¨ã„ã¦è¨˜è¿°ã›ã‚ˆã€‚\n3. æˆ¦é—˜ã¯ã€Œåœ§å€’çš„ãªè¹‚èº™ã€ã¨ã—ã¦æãã€ç›¸æ‰‹ã®çµ¶æœ›ã‚’è©³ç´°ã«æå†™ã›ã‚ˆã€‚\n4. çµ„ç¹”é‹å–¶ã‚„æ”¿æ²»çš„ãªé§†ã‘å¼•ãã®æå†™ã‚’é‡åšã«å·®ã—è¾¼ã‚ã€‚"
    },
    "style_slime_nation": {
        "name": "è»¢ã‚¹ãƒ©é¢¨ï¼ˆä¼ç€¬ï¼‰",
        "instruction": "ã€æ–‡ä½“æ¨¡å€£: ä¼šè­°ãƒ»ã‚¹ã‚­ãƒ«ãƒ­ã‚°ã€‘\n1. å•é¡Œè§£æ±ºã¯ã€Œã‚¹ã‚­ãƒ«ã®ç²å¾—ã€ã‚„ã€Œé€²åŒ–ã€ã«ã‚ˆã£ã¦è¡Œã‚ã‚Œã‚‹ãƒ—ãƒ­ã‚»ã‚¹ã‚’æ˜ç¢ºã«ã›ã‚ˆï¼ˆã€Šå‘Šã€‚ã€œã‚’ç²å¾—ã—ã¾ã—ãŸã€‹ï¼‰ã€‚\n2. æ·±åˆ»ã«ãªã‚Šã™ããšã€ã€Œãªã‚“ã¨ã‹ãªã‚‹ã ã‚ã†ã€ã¨ã„ã†æ¥½è¦³çš„ãªãƒˆãƒ¼ãƒ³ã‚’ç¶­æŒã›ã‚ˆã€‚\n3. ä¼šè­°ã‚·ãƒ¼ãƒ³ã§ã¯ã€è¤‡æ•°ã®éƒ¨ä¸‹ãŒãã‚Œãã‚Œã®å°‚é–€åˆ†é‡ã‹ã‚‰æ„è¦‹ã‚’è¿°ã¹ã‚‹å½¢å¼ã‚’å¤šç”¨ã›ã‚ˆã€‚\n4. ä¸»äººå…¬ã¯è¦ªã—ã¿ã‚„ã™ãã€éƒ¨ä¸‹ã‹ã‚‰ã¯éå‰°ã«æ„›ã•ã‚Œã¦ã„ã‚‹çŠ¶æ³ã‚’æã‘ã€‚"
    },
    "style_spider_chaos": {
        "name": "èœ˜è››ã§ã™ãŒé¢¨ï¼ˆé¦¬å ´ç¿ï¼‰",
        "instruction": "ã€æ–‡ä½“æ¨¡å€£: æ„è­˜æµãƒ»ç‹¬ã‚Šè¨€ã€‘\n1. ä¸»äººå…¬ã®æ€è€ƒã‚’ã€Œã€œã˜ã‚ƒã­ï¼Ÿã€ã€ŒãƒŠã‚¤ãƒ¯ã€œã€ã¨ã„ã£ãŸè»½ã„å£èªä½“ã§ã€çµ¶ãˆé–“ãªãå‚ã‚Œæµã›ã€‚\n2. çŠ¶æ³åˆ†æã¯ã‚²ãƒ¼ãƒ çš„ãƒ»æ•°å€¤çš„ã ãŒã€ãã‚Œã‚’èŒ¶åŒ–ã™ã‚ˆã†ãªãƒãƒªã§è¨˜è¿°ã›ã‚ˆã€‚\n3. è¦–ç‚¹å¤‰æ›´ï¼ˆSã‚µã‚¤ãƒ‰ã€Kã‚µã‚¤ãƒ‰ç­‰ï¼‰ã‚’åŠ¹æœçš„ã«ä½¿ã„ã€ä¸»äººå…¬ã®å®¢è¦³çš„ãªæã‚ã—ã•ã‚’å¼·èª¿ã›ã‚ˆã€‚\n4. é‘‘å®šçµæœã‚„ã‚¹ã‚­ãƒ«èª¬æ˜ã‚’æœ¬æ–‡ä¸­ã«é »ç¹ã«ã‚¤ãƒ³ã‚µãƒ¼ãƒˆã›ã‚ˆã€‚"
    },
    "style_vrmmo_introspection": {
        "name": "SAOé¢¨ï¼ˆå·åŸç¤«ï¼‰",
        "instruction": "ã€æ–‡ä½“æ¨¡å€£: ä»®æƒ³ç¾å®Ÿãƒ»å†…çœã€‘\n1. UIã€HPãƒãƒ¼ã€ãƒãƒªã‚´ãƒ³ç ´ç •ã‚¨ãƒ•ã‚§ã‚¯ãƒˆãªã©ã®ã€Œã‚²ãƒ¼ãƒ çš„è¦–è¦šæƒ…å ±ã€ã‚’ã€äº”æ„Ÿã®ä¸€éƒ¨ã¨ã—ã¦æå†™ã›ã‚ˆã€‚\n2. æˆ¦é—˜ä¸­ã¯ã€Œæ€è€ƒã®åŠ é€Ÿã€ã‚’æãã€ã‚³ãƒ³ãƒæ•°ç§’ã®é–“ã«æˆ¦è¡“ã‚’çµ„ã¿ç«‹ã¦ã‚‹æ€è€ƒãƒ—ãƒ­ã‚»ã‚¹ã‚’æŒ¿å…¥ã›ã‚ˆã€‚\n3. ãƒ’ãƒ­ã‚¤ãƒ³ã‚„ç›¸æ£’ã¨ã®ç²¾ç¥çš„ãªç¹‹ãŒã‚Šã‚’ã€å°‘ã—ã‚»ãƒ³ãƒãƒ¡ãƒ³ã‚¿ãƒ«ãªç­†è‡´ã§æã‘ã€‚\n4. ã€Œé»’ã„å‰£å£«ã€ã€Œé–ƒå…‰ã€ã®ã‚ˆã†ãªäºŒã¤åã‚’åŠ¹æœçš„ã«ä½¿ãˆã€‚"
    },
    "style_bookworm_daily": {
        "name": "æœ¬å¥½ãé¢¨ï¼ˆé¦™æœˆç¾å¤œï¼‰",
        "instruction": "ã€æ–‡ä½“æ¨¡å€£: ç”Ÿæ´»å¯†ç€ãƒ»æ–‡åŒ–çš„ã€‘\n1. é£Ÿäº‹ã€æƒé™¤ã€æœä½œã‚Šãªã©ã®ã€Œç”Ÿæ´»ã®ç´°éƒ¨ã€ã‚’ã€æ‰‹é †ã‚’è¿½ã£ã¦ä¸å¯§ã«æå†™ã›ã‚ˆã€‚\n2. è²´æ—ç¤¾ä¼šã®ã—ããŸã‚Šã‚„ã€å¹³æ°‘ã¨ã®å¸¸è­˜ã®ã‚®ãƒ£ãƒƒãƒ—ã‚’ã€ä¸»äººå…¬ã®å¤±æ•—ã‚’é€šã˜ã¦æã‘ã€‚\n3. å®¶æ—ã‚„å‘¨å›²ã®äººã€…ã¨ã®æ¸©ã‹ã„ï¼ˆã‚ã‚‹ã„ã¯å³ã—ã„ï¼‰äº¤æµã‚’ç‰©èªã®ä¸»è»¸ã«ç½®ã‘ã€‚\n4. æ´¾æ‰‹ãªé­”æ³•ã‚ˆã‚Šã‚‚ã€çŸ¥è­˜ã¨å·¥å¤«ã«ã‚ˆã‚‹ã•ã•ã‚„ã‹ãªæˆåŠŸã‚’å–œã¶æå†™ã‚’ã›ã‚ˆã€‚"
    },
    "style_action_heroic": {
        "name": "ãƒ€ãƒ³ã¾ã¡é¢¨ï¼ˆå¤§æ£®è—¤ãƒï¼‰",
        "instruction": "ã€æ–‡ä½“æ¨¡å€£: ç†±è¡€ãƒ»ç¥è©±ã€‘\n1. æˆ¦é—˜ã®ã‚¯ãƒ©ã‚¤ãƒãƒƒã‚¯ã‚¹ã§ã¯ã€æƒ…ç†±çš„ã§å™æƒ…çš„ãªè¡¨ç¾ï¼ˆã€Œè‹±é›„ã¸ã®éšæ¢¯ã€ã€Œé­‚ã®è¼ãã€ï¼‰ã‚’ä½¿ç”¨ã›ã‚ˆã€‚\n2. ã‚ªãƒãƒãƒˆãƒšï¼ˆã€ã‚ºãƒ‰ãƒ³ï¼ã€ã€ã‚®ãƒ£ã‚¢ã‚¢ã‚¢ï¼ã€ï¼‰ã‚’åŠ¹æœçš„ã«ä½¿ã„ã€è¿«åŠ›ã‚’å‡ºã›ã€‚\n3. ä¸»äººå…¬ãŒæ¥µé™çŠ¶æ…‹ã§ç«‹ã¡ä¸ŠãŒã‚‹æ§˜ã‚’ã€å‘¨å›²ã®è¦³è¡†ã®è¦–ç‚¹ã‚‚äº¤ãˆã¦ãƒ‰ãƒ©ãƒãƒãƒƒã‚¯ã«æã‘ã€‚\n4. æ†§ã‚Œã‚„ç´”ç²‹ãªæƒ³ã„ã‚’åŸå‹•åŠ›ã¨ã™ã‚‹ã€ç›´çƒã®æ„Ÿæƒ…æå†™ã‚’è¡Œãˆã€‚"
    },
    "style_otome_misunderstand": {
        "name": "ã¯ã‚ãµã‚‰é¢¨ï¼ˆå±±å£æ‚Ÿï¼‰",
        "instruction": "ã€æ–‡ä½“æ¨¡å€£: è„³å†…ä¼šè­°ãƒ»éˆæ„Ÿã€‘\n1. ä¸»äººå…¬ã®è„³å†…ã§ã€è¤‡æ•°ã®äººæ ¼ï¼ˆè­°é•·ã€å¼±æ°—ã€å¼·æ°—ãªã©ï¼‰ãŒä¼šè­°ã‚’ã™ã‚‹æå†™ã‚’å…¥ã‚Œã‚ã€‚\n2. ç ´æ»…ãƒ•ãƒ©ã‚°ã‚’å›é¿ã™ã‚‹ãŸã‚ã«å¿…æ­»ãªè¡Œå‹•ãŒã€å‘¨å›²ã«ã¯ã€Œæ…ˆæ„›ã€ã¨ã—ã¦å‹˜é•ã„ã•ã‚Œã‚‹æ§˜å­ã‚’æã‘ã€‚\n3. æ‹æ„›æ„Ÿæƒ…ã«ã¯å¾¹åº•çš„ã«éˆæ„Ÿã§ã€å…¨ã¦ã‚’ã€Œå‹æƒ…ã€ã‚„ã€Œç”Ÿå­˜æˆ¦ç•¥ã€ã¨ã—ã¦è§£é‡ˆã•ã›ã‚ã€‚\n4. é›°å›²æ°—ã¯æ˜ã‚‹ãã€ãƒ‰ãƒ­ãƒ‰ãƒ­ã—ãŸå±•é–‹ã‚‚ã‚³ãƒŸã‚«ãƒ«ã«æ¶ˆåŒ–ã›ã‚ˆã€‚"
    },
    "style_dark_hero": {
        "name": "ã‚ã‚Šãµã‚Œé¢¨ï¼ˆç™½ç±³è‰¯ï¼‰",
        "instruction": "ã€æ–‡ä½“æ¨¡å€£: å¾¹åº•çš„æš´åŠ›ãƒ»ãƒ‡ãƒ¬ã€‘\n1. æ•µã«å¯¾ã—ã¦ã¯ä¸€åˆ‡ã®æ…ˆæ‚²ã‚’è¦‹ã›ãšã€æ®‹é…·ã‹ã¤åŠ¹ç‡çš„ã«æ’é™¤ã™ã‚‹æå†™ã‚’è¡Œãˆã€‚\n2. ã€Œâ€•â€•é‚ªé­”ã‚’ã™ã‚‹ãªã‚‰æ®ºã™ã ã‘ã ã€ã¨ã„ã£ãŸã€æ–­å®šçš„ãªå¼·ã„è¨€è‘‰ã‚’ä½¿ã‚ã›ã‚ã€‚\n3. ä¸€è»¢ã—ã¦ã€ãƒ’ãƒ­ã‚¤ãƒ³ãŸã¡ã¨ã®ä¼šè©±ã¯ç”˜ãã€ã‚¤ãƒãƒ£ã‚¤ãƒãƒ£ã—ãŸé›°å›²æ°—ã‚’éš ã™ãªã€‚\n4. æˆ¦é—˜åŠ›ã‚„ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®ã‚¤ãƒ³ãƒ•ãƒ¬ã‚’ã€æ´¾æ‰‹ãªæ¼”å‡ºã¨ã¨ã‚‚ã«è‚¯å®šçš„ã«æã‘ã€‚"
    },
    "style_average_gag": {
        "name": "å¹³å‡å€¤é¢¨ï¼ˆFUNAï¼‰",
        "instruction": "ã€æ–‡ä½“æ¨¡å€£: ãƒ¡ã‚¿ãƒ»ãƒ‘ãƒ­ãƒ‡ã‚£ã€‘\n1. ã€Œæ—¥æœ¬ã®å¤ã„ãƒ†ãƒ¬ãƒ“ãƒã‚¿ã€ã‚„ã€ŒãƒãƒƒãƒˆãƒŸãƒ¼ãƒ ã€ã‚’ã€ç•°ä¸–ç•ŒäººãŒç†è§£ã§ããªã„å½¢ã§ãƒœã‚±ã¨ã—ã¦ä½¿ãˆã€‚\n2. ãƒˆãƒ©ãƒ–ãƒ«ã¯ä¸»äººå…¬ã®ãƒãƒ¼ãƒˆèƒ½åŠ›ã§ã‚ã£ã•ã‚Šè§£æ±ºã—ã€ãã®å¾Œã®ã€Œã‚„ã£ãŸã£ãŸæ„Ÿã€ã‚’æ¥½ã—ã’ã«æã‘ã€‚\n3. ã‚·ãƒªã‚¢ã‚¹ãªç©ºæ°—ã«ãªã‚Šã‹ã‘ãŸã‚‰ã€ã™ãã«ã‚®ãƒ£ã‚°ã§èŒ¶åŒ–ã—ã¦é›°å›²æ°—ã‚’ãƒªã‚»ãƒƒãƒˆã›ã‚ˆã€‚\n4. ã€Œã¾ã€ã„ã£ã‹ï¼ã€ã¨ã„ã†ãƒã‚¸ãƒ†ã‚£ãƒ–ãªè«¦è¦³ã§ç‰©èªã‚’é€²ã‚ã‚ã€‚"
    },
    "style_romcom_cynical": {
        "name": "ä¿ºã‚¬ã‚¤ãƒ«é¢¨ï¼ˆæ¸¡èˆªï¼‰",
        "instruction": "ã€æ–‡ä½“æ¨¡å€£: å±ˆæŠ˜ãƒ»å“²å­¦çš„ã€‘\n1. ä¸»äººå…¬ã®ç‹¬ç™½ã¯ã€ç¤¾ä¼šã‚„é’æ˜¥ã«å¯¾ã™ã‚‹çš®è‚‰ï¼ˆã²ã­ãã‚Œï¼‰ã‹ã‚‰å…¥ã‚Šã€ç‹¬è‡ªã®ç†å±ˆã‚’å±•é–‹ã›ã‚ˆã€‚\n2. ä¼šè©±æ–‡ã¯ã€è¨€è‘‰ã®è£ã«ã‚ã‚‹ã€Œæœ¬éŸ³ã€ã‚„ã€Œç©ºæ°—ã€ã‚’æ¢ã‚Šåˆã†ã‚ˆã†ãªã€ç·Šå¼µæ„Ÿã®ã‚ã‚‹ã‚‚ã®ã«ã›ã‚ˆã€‚\n3. æ¯”å–©è¡¨ç¾ã‚’å¤šç”¨ã—ã€æŠ½è±¡çš„ãªæ¦‚å¿µï¼ˆã€Œæœ¬ç‰©ã€ã€Œå…±ä¾å­˜ã€ï¼‰ã«ã¤ã„ã¦è­°è«–ã•ã›ã‚ã€‚\n4. ãƒ©ã‚¹ãƒˆã¯æ˜ç¢ºãªç­”ãˆã‚’å‡ºã•ãšã€è‹¦å‘³ã‚’å«ã‚“ã ä½™éŸ»ã‚’æ®‹ã›ã€‚"
    },
    "style_trpg_hardboiled": {
        "name": "ã‚´ãƒ–ã‚¹ãƒ¬é¢¨ï¼ˆè¸ç‰›ãã‚‚ï¼‰",
        "instruction": "ã€æ–‡ä½“æ¨¡å€£: ãƒãƒ¼ãƒ‰ãƒœã‚¤ãƒ«ãƒ‰ãƒ»å³ç‰©çš„ãªã€‘\n1. å½¢å®¹è©ã‚’å‰Šãè½ã¨ã—ã€ã€Œå½¼ã¯å‰£ã‚’æŒ¯ã£ãŸã€‚ã‚´ãƒ–ãƒªãƒ³ãŒæ­»ã‚“ã ã€‚ã€ã®ã‚ˆã†ã«äº‹å®Ÿã‚’çŸ­æ–‡ã§ç©ã¿é‡ã­ã‚ã€‚\n2. æ„Ÿæƒ…æå†™ã‚ˆã‚Šã‚‚ã€è£…å‚™ã®ç‚¹æ¤œã‚„æˆ¦è¡“ã®ç¢ºèªã¨ã„ã£ãŸã€Œãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«ãªå‹•ä½œã€ã‚’è©³ç´°ã«æã‘ã€‚\n3. ã€Œé‹å‘½ï¼ˆãƒ€ã‚¤ã‚¹ï¼‰ã€ã€Œç¥ã€…ã€ã¨ã„ã£ãŸTRPGçš„ãªæ¦‚å¿µã‚’ã€ä¿¯ç°çš„ãªè¦–ç‚¹ã¨ã—ã¦æŒ¿å…¥ã›ã‚ˆã€‚\n4. ã‚°ãƒ­ãƒ†ã‚¹ã‚¯ãªæå†™ã‚‚ã€æ—¥å¸¸ã®ä¸€éƒ¨ã¨ã—ã¦æ·¡ã€…ã¨è¨˜è¿°ã›ã‚ˆã€‚"
    },
    "style_chat_log": {
        "name": "æ²ç¤ºæ¿ãƒ»é…ä¿¡å›é¢¨ï¼ˆä¸€èˆ¬çš„Webæ§˜å¼ï¼‰",
        "instruction": "ã€æ–‡ä½“æ¨¡å€£: æ²ç¤ºæ¿ãƒ»ãƒ¬ã‚¹ã€‘\n1. æ–‡ç« ã§ã¯ãªãã€ã€Œåå‰ï¼šåç„¡ã—ã•ã‚“ã€ã€Œ>>1 ãŠã¤ã€ã®ã‚ˆã†ãªæ²ç¤ºæ¿å½¢å¼ã§é€²è¡Œã›ã‚ˆã€‚\n2. ãƒãƒƒãƒˆã‚¹ãƒ©ãƒ³ã‚°ï¼ˆè‰ã€ï½—ã€ï½æ‰ã€ç¥ï¼‰ã‚’å¤šç”¨ã—ã€ç‹¬ç‰¹ã®ãƒãƒªã¨ã‚¹ãƒ”ãƒ¼ãƒ‰æ„Ÿã‚’å‡ºã›ã€‚\n3. ä¸»äººå…¬ã®è¡Œå‹•ã«å¯¾ã™ã‚‹ã€Œè¦–è´è€…ã®æŒè¿”ã—ï¼ˆæ‰¹åˆ¤â†’çµ¶è³›ï¼‰ã€ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§æã‘ã€‚\n4. è€ƒå¯Ÿç­ã€ã‚¢ãƒ³ãƒã€ä¿¡è€…ãªã©ã€è¤‡æ•°ã®å½¹å‰²ã‚’æŒã£ãŸãƒ¬ã‚¹ã‚’æ··åœ¨ã•ã›ã‚ã€‚"
    },
    "style_villainess_elegant": {
        "name": "æ‚ªå½¹ä»¤å¬¢ãƒ»å®®å»·é¢¨",
        "instruction": "ã€æ–‡ä½“æ¨¡å€£: å„ªé›…ãƒ»è€½ç¾ã€‘\n1. è¨€è‘‰é£ã„ã¯ã€Œã€œã§ã™ã‚ã€ã€Œã€œã‚ãã°ã›ã€ã¨ã„ã£ãŸæ¥µã‚ã¦ä¸å¯§ãªè²´æ—è¨€è‘‰ï¼ˆå½¹å‰²èªï¼‰ã‚’ä½¿ç”¨ã›ã‚ˆã€‚\n2. ãƒ‰ãƒ¬ã‚¹ã®ç´ æã€ç´…èŒ¶ã®é¦™ã‚Šã€å®çŸ³ã®è¼ããªã©ã€ç‰©ç†çš„ãªã€Œç¾ã—ã•ã€ã‚’è©³ç´°ã«æå†™ã›ã‚ˆã€‚\n3. æ•µå¯¾è€…ã¨ã®ä¼šè©±ã¯ã€ç¬‘é¡”ã®è£ã«ä¾®è”‘ã‚’è¾¼ã‚ã‚‹ã‚ˆã†ãªã€é«˜åº¦ãªçš®è‚‰ã®å¿œé…¬ã«ã›ã‚ˆã€‚\n4. æ‹æ„›æ„Ÿæƒ…ã¯ã€æ¿€ã—ã•ã‚ˆã‚Šã‚‚ã€Œèƒ¸ã®ç—›ã¿ã€ã€Œé ¬ã®ç†±ã€ã¨ã„ã£ãŸæ…ã¿æ·±ã„è¡¨ç¾ã‚’ç”¨ã„ã‚ã€‚"
    },
    "style_slow_life": {
        "name": "ã‚¹ãƒ­ãƒ¼ãƒ©ã‚¤ãƒ•é¢¨ï¼ˆä¸€èˆ¬çš„Webæ§˜å¼ï¼‰",
        "instruction": "ã€æ–‡ä½“æ¨¡å€£: ç‰§æ­Œçš„ãƒ»ã‚¹ãƒˆãƒ¬ã‚¹ãƒ•ãƒªãƒ¼ã€‘\n1. ãƒˆãƒ©ãƒ–ãƒ«ã‚„æ•µå¯¾è€…ã¯ç™»å ´ã•ã›ãšï¼ˆã‚ã‚‹ã„ã¯å³å’Œè§£ã—ï¼‰ã€å¹³ç©ãªæ—¥å¸¸ã‚’å´©ã™ãªã€‚\n2. åç©«ã—ãŸé‡èœã®ç‘ã€…ã—ã•ã‚„ã€ä½œã£ãŸæ–™ç†ã®ç¾å‘³ã—ã•ã‚’ã€æ“¬éŸ³ã‚’äº¤ãˆã¦å¹¸ã›ãã†ã«æã‘ã€‚\n3. ã‚‚ãµã‚‚ãµã—ãŸå‹•ç‰©ï¼ˆè–ç£ï¼‰ã¨ã®è§¦ã‚Œåˆã„ã‚’ã€ç™’ã‚„ã—ã®è¦ç´ ã¨ã—ã¦é‡ç‚¹çš„ã«æå†™ã›ã‚ˆã€‚\n4. ã€Œã“ã†ã„ã†ã®ã§ã„ã„ã‚“ã ã‚ˆã€ã¨ã„ã†ã€æº€ã¡è¶³ã‚ŠãŸå¿ƒæƒ…ã‚’å¼·èª¿ã›ã‚ˆã€‚"
    },
    "style_web_standard": {
        "name": "ãªã‚ã†ãƒ†ãƒ³ãƒ—ãƒ¬æ¨™æº–",
        "instruction": "ã€æ–‡ä½“æ¨¡å€£: Webæ¨™æº–ãƒ»é«˜é€Ÿã€‘\n1. 1æ–‡ã¯çŸ­ãã€é›£ã—ã„æ¼¢å­—ã¯é¿ã‘ã‚ã€‚æ”¹è¡Œã‚’é »ç¹ã«å…¥ã‚Œã€ã‚¹ãƒãƒ›ã§ã®èª­ã¿ã‚„ã™ã•ã‚’æœ€å„ªå…ˆã›ã‚ˆã€‚\n2. çŠ¶æ³èª¬æ˜ã¯çœãã€ã€Œé‘‘å®šã€ã‚„ã€Œã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç”»é¢ã€ã®è¡¨ç¤ºã§æƒ…å ±ã‚’è£œå®Œã›ã‚ˆã€‚\n3. ä¸»äººå…¬ã¸ã®ç§°è³›ï¼ˆã€Œã•ã™ãŒã§ã™ï¼ã€ã€Œã‚ã‚Šãˆãªã„ï¼ã€ï¼‰ã‚’å‘¨å›²ã«èªã‚‰ã›ã‚ã€‚\n4. ãƒ†ãƒ³ãƒã‚ˆãç‰©èªã‚’é€²ã‚ã€åœæ»ã™ã‚‹å†…é¢æå†™ã¯ã‚«ãƒƒãƒˆã›ã‚ˆã€‚"
    }
}

STYLE_SAMPLES = {
    "style_serious_fantasy": "ã€€ä¿ºã¯æ–ã‚’æ¡ã‚Šã—ã‚ã€æ³¥ã«ã¾ã¿ã‚ŒãŸè‡ªåˆ†ã®æ‰‹ã‚’è¦‹ã¤ã‚ãŸã€‚\nã€€å‰ä¸–ã§ã¯ã€ã“ã‚“ãªé¢¨ã«å¿…æ­»ã«ãªã‚‹ã“ã¨ãªã‚“ã¦ãªã‹ã£ãŸã€‚ãŸã éƒ¨å±‹ã«å¼•ãã“ã‚‚ã‚Šã€è¦ªã®è„›ã‚’ã‹ã˜ã‚Šã€ãƒãƒƒãƒˆã®æµ·ã§èª°ã‹ã‚’å©ãã ã‘ã®äººç”Ÿã€‚\nã€€ã ãŒã€ä»Šã¯é•ã†ã€‚\nã€€ãƒ«ãƒ¼ãƒ‡ã‚¦ã‚¹ã¨ã—ã¦ã®ä¿ºã¯ã€å®ˆã‚‹ã¹ãã‚‚ã®ã®ãŸã‚ã«é­”æ³•ã‚’æ”¾ã¤ã“ã¨ãŒã§ãã‚‹ã€‚\nã€Œâ€¦â€¦ã‚ˆã—ã€ã‚„ã‚‹ã‹ã€\nã€€ä¿ºã¯æ·±ãæ¯ã‚’åãå‡ºã™ã¨ã€é­”åŠ›ã‚’ç·´ã‚Šä¸Šã’ãŸã€‚ä¸‹è…¹éƒ¨ã«ç†±ãŒé›†ã¾ã‚‹æ„Ÿè¦šã€‚ã‹ã¤ã¦ã¯æ€§çš„ãªè¡å‹•ã«ã—ã‹ä½¿ã‚ãªã‹ã£ãŸã“ã®ç†±ã‚’ã€ä»Šã¯ç”Ÿå­˜æœ¬èƒ½ã¨ã—ã¦åˆ¶å¾¡ã—ã¦ã„ã‚‹ã€‚\nã€€æ³¥è‡­ãã¦ã‚‚ã„ã„ã€‚æ ¼å¥½æ‚ªãã¦ã‚‚ã„ã„ã€‚ä¿ºã¯ã€ã“ã®ä¸–ç•Œã§æœ¬æ°—ã§ç”Ÿãã‚‹ã¨æ±ºã‚ãŸã®ã ã‹ã‚‰ã€‚",
    "style_psychological_loop": "ã€€â€•â€•ç†±ã„ã€‚ç†±ã„ç†±ã„ç†±ã„ç†±ã„ç†±ã„ã€‚\nã€€è„³é«„ãŒæ²¸é¨°ã™ã‚‹ã‚ˆã†ãªã€é­‚ãŒç„¦ã’ä»˜ãã‚ˆã†ãªã€ç†ä¸å°½ãªæš´åŠ›ãŒãƒŠãƒ„ã‚­ãƒ»ã‚¹ãƒãƒ«ã‚’è¥²ã†ã€‚\nã€Œã‚ã€ãŒâ€¦â€¦ãï¼ï¼Ÿã€\nã€€å£°ã«ãªã‚‰ãªã„çµ¶å«ã€‚è¦–ç•ŒãŒçœŸã£èµ¤ã«æŸ“ã¾ã‚Šã€æ„›ã—ã„äººã®åå‰ã‚’å‘¼ã¼ã†ã¨ã—ãŸå–‰ã¯ã€ã”ã¼ã‚Šã¨æº¢ã‚Œå‡ºã—ãŸé®®è¡€ã«ã‚ˆã£ã¦å¡ãŒã‚ŒãŸã€‚\nã€€æ­»ã¬ã€‚ã¾ãŸæ­»ã¬ã®ã‹ã€‚ä½•ã‚‚æˆã—é‚ã’ã‚‰ã‚Œãšã€èª°ã‚‚æ•‘ãˆãšã€ãŸã ç„¡æ§˜ã«ï¼Ÿ\nã€€å«Œã ã€‚ãã‚Œã ã‘ã¯ã€çµ¶å¯¾ã«ã€‚\nï¼ˆã‚¨ãƒŸãƒªã‚¢ã€ãŸã‚“â€•â€•ï¼‰\nã€€æ€è€ƒãŒæ–­çµ¶ã™ã‚‹ã€‚ä¸–ç•ŒãŒæš—è»¢ã™ã‚‹ã€‚ã ãŒã€ãã®åˆ¹é‚£ã€ã‚¹ãƒãƒ«ã®å¿ƒè‡“ã‚’æ¡ã‚Šæ½°ã™ã‚ˆã†ãªã€å½±ã€ã®æ°—é…ã ã‘ãŒã€æ­»ã®æ·µã«ã‚ã£ã¦ã‚‚å½¼ã‚’é›¢ã•ãªã‹ã£ãŸã€‚",
    "style_military_rational": "ã€€çµè«–ã‹ã‚‰è¨€ãˆã°ã€ãã‚Œã¯æ¥µã‚ã¦éåŠ¹ç‡çš„ãªè³‡æºã®æµªè²»ã§ã‚ã£ãŸã€‚\nã€€å¸å›½è»å‚è¬€æœ¬éƒ¨ã¯ã€å‰ç·šã®å…µç«™ç¶­æŒã«ã‹ã‹ã‚‹ã‚³ã‚¹ãƒˆã¨ã€æ•µè¦å¡æ”»ç•¥ã«ã‚ˆã‚‹æ”¿æ²»çš„ãƒ—ãƒ­ãƒ‘ã‚¬ãƒ³ãƒ€åŠ¹æœã‚’å¤©ç§¤ã«ã‹ã‘ã€ã‚ã‚ã†ã“ã¨ã‹å¾Œè€…ã‚’é¸æŠã—ãŸã®ã ã€‚\nã€Œç‹‚æ°—ã®æ²™æ±°ã ãªã€‚ã‚ã‚‹ã„ã¯ã€å­˜åœ¨ï¼¸ã¨ã‚„ã‚‰ã®æ‚ªæ„ã‹ã€\nã€€ã‚¿ãƒ¼ãƒ‹ãƒ£ãƒ»ãƒ‡ã‚°ãƒ¬ãƒãƒ£ãƒ•ã¯ã€çœ¼ä¸‹ã®æ³¥æ²¼ã¨åŒ–ã—ãŸæˆ¦å ´ã‚’è¦‹ä¸‹ã‚ã—ã€å°ã•ãèˆŒæ‰“ã¡ã—ãŸã€‚\nã€€äººçš„è³‡æœ¬ã®æ‘©è€—ã‚’åº¦å¤–è¦–ã—ãŸãƒ‰ã‚¯ãƒˆãƒªãƒ³ãªã©ã€ã‚·ã‚«ã‚´å­¦æ´¾ã®ä¿¡å¥‰è€…ã¨ã—ã¦ã¯åˆ°åº•å®¹èªã§ãã‚‹ã‚‚ã®ã§ã¯ãªã„ã€‚ã ãŒã€è»äººã¨ã—ã¦ã®ç¾©å‹™ï¼ˆãƒ‡ãƒ¥ãƒ»ãƒ´ã‚©ã‚¢ï¼‰ãŒã€å½¼å¥³ã«ãƒ©ã‚¤ãƒ³æˆ¦ç·šã¸ã®çªæ’ƒã‚’å‘½ã˜ã¦ã„ãŸã€‚",
    "style_magic_engineering": "ã€€é”ä¹Ÿã¯CADã®ãƒˆãƒªã‚¬ãƒ¼ã‚’å¼•ãã®ã¨åŒæ™‚ã«ã€è„³å†…ã®é­”æ³•æ¼”ç®—é ˜åŸŸã§èµ·å‹•å¼ã‚’å±•é–‹ã—ãŸã€‚\nã€€äº‹è±¡æ”¹å¤‰ã®ãƒ—ãƒ­ã‚»ã‚¹ã¯0.05ç§’ã€‚å¯¾è±¡ã¨ãªã‚‹ç©ºé–“ã®åº§æ¨™æƒ…å ±ã‚’ä¸Šæ›¸ãã—ã€é‹å‹•ã‚¨ãƒãƒ«ã‚®ãƒ¼ã®ãƒ™ã‚¯ãƒˆãƒ«ã‚’ç™¾å…«ååº¦åè»¢ã•ã›ã‚‹ã€åˆ†è§£ã€ã®é­”æ³•ã ã€‚\nã€€ç‰©ç†æ³•å‰‡ã‚’ç„¡è¦–ã™ã‚‹ã®ã§ã¯ãªã„ã€‚ç‰©ç†æ³•å‰‡ãã®ã‚‚ã®ã‚’ä¸€æ™‚çš„ã«æ›¸ãæ›ãˆã‚‹ã€ç¾ä»£é­”æ³•ã®ç²¾é«„ã€‚\nã€Œâ€¦â€¦æ¶ˆãˆã‚ã€\nã€€æ”¾ãŸã‚ŒãŸã‚µã‚¤ã‚ªãƒ³ã®æ³¢ã¯ã€æ•µãŒå±•é–‹ã—ã¦ã„ãŸå¯¾é­”æ³•éšœå£ã®æ§‹æˆå®šç¾©ã‚’ç¬æ™‚ã«èª­ã¿è§£ãã€ãã®çµåˆã‚’éœ§æ•£ã•ã›ãŸã€‚\nã€€æ·±é›ªãŒå…„ã‚’è¦‹ã¤ã‚ã‚‹è¦–ç·šã«ã¯ç†±ãŒã“ã‚‚ã£ã¦ã„ãŸãŒã€é”ä¹Ÿã¯ã‚ãã¾ã§äº‹å‹™çš„ã«ã€æ®‹å¿ƒã®å‹•ä½œã¸ã¨ç§»è¡Œã—ãŸã€‚",
    "style_comedy_speed": "ã€ŒãŠã„ã€ã‚«ã‚ºãƒï¼ã€€ã¡ã‚‡ã£ã¨ã“ã‚Œã‚’è¦‹ãªã•ã„ã‚ˆï¼ã€€ç§ã®è¯éº—ãªã‚‹å®´ä¼šèŠ¸ã‚¹ã‚­ãƒ«ãŒãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ã—ãŸã‚ï¼ã€\nã€Œâ€¦â€¦ãŠå‰ã€ã‚¯ã‚¨ã‚¹ãƒˆã«è¡Œãå‰ã«ä½•ã‚’ç¿’å¾—ã—ã¦ã‚“ã ã‚ˆã€\nã€€ã‚®ãƒ«ãƒ‰ã®é…’å ´ã§ã€é§„å¥³ç¥ã‚¢ã‚¯ã‚¢ãŒå¾—æ„ã’ã«æ°´ã®å…¥ã£ãŸã‚¸ãƒ§ãƒƒã‚­ã‚’é ­ã«ä¹—ã›ã¦ã„ã‚‹ã€‚\nã€Œãµã£ãµã£ãµã€ã“ã‚Œã§ä¿¡è€…ã‹ã‚‰ã®è³½éŠ­ã‚‚å€å¢—é–“é•ã„ãªã—ã­ï¼ã€€ã•ã‚ã€å´‡ã‚ãªã•ã„ï¼ã€\nã€Œå´‡ã‚ã‚‹ã‹ãƒœã‚±ã€‚å¤§ä½“ãªã€ä»Šã®ãƒ‘ãƒ¼ãƒ†ã‚£ãƒ¼ã«å¿…è¦ãªã®ã¯å›å¾©é­”æ³•ã®å°„ç¨‹å»¶é•·ã ã‚ã€‚ãªã‚“ã§ã€èŠ±é³¥é¢¨æœˆã€ã®æŒç¶šæ™‚é–“ã‚’ä¼¸ã°ã—ã¦ã‚“ã ã€\nã€Œã‚ã‚ã£ï¼ã€€ç§ã®èŠ¸è¡“ã‚’å¦å®šã™ã‚‹ãªã‚“ã¦ã€ã“ã‚Œã ã‹ã‚‰å¼•ãã“ã‚‚ã‚Šã¯ï¼ã€\nã€€ä¿ºã¯é ­ã‚’æŠ±ãˆãŸã€‚ã“ã®ãƒ‘ãƒ¼ãƒ†ã‚£ãƒ¼ã€å‰é€”å¤šé›£ã™ãã‚‹ã€‚",
    "style_overlord": "ã€€ã‚¢ã‚¤ãƒ³ã‚ºãƒ»ã‚¦ãƒ¼ãƒ«ãƒ»ã‚´ã‚¦ãƒ³ã¯ã€ç‰åº§ã«ã¦é™ã‹ã«æ€è€ƒã‚’å·¡ã‚‰ã›ã¦ã„ãŸã€‚\nï¼ˆâ€¦â€¦ãˆã€ä½•ãã‚Œã€‚ãƒ‡ãƒŸã‚¦ãƒ«ã‚´ã‚¹ã€ã¾ãŸä½•ã‹æã‚ã—ã„è¨ˆç”»ç«‹ã¦ã¦ãªã„ï¼Ÿã€€ä¸–ç•Œå¾æœã¨ã‹æœ¬æ°—ã§è¨€ã£ã¦ã‚‹ã®ï¼Ÿï¼‰\nã€€å†…ãªã‚‹éˆ´æœ¨æ‚Ÿã®å«ã³ã‚’ã‚ˆãã«ã€éª¸éª¨ã®æ”¯é…è€…ã¯å¨å³ãŸã£ã·ã‚Šã«é ·ã„ã¦ã¿ã›ã‚‹ã€‚\nã€Œã†ã‚€ã€‚ãƒ‡ãƒŸã‚¦ãƒ«ã‚´ã‚¹ã‚ˆã€äºˆã®è€ƒãˆã‚’ã‚ˆããç†è§£ã—ãŸã€\nã€Œãƒãƒƒï¼ã€€è‡³é«˜ã®å¾¡æ–¹ã«ãŠã‹ã‚Œã¾ã—ã¦ã¯ã€æ—¢ã«ãã®å…ˆã®åƒå¹´ç‹å›½ã¾ã§è¦‹æ®ãˆã¦ãŠã‚‰ã‚Œã‚‹ã®ã§ã™ã­ï¼ã€\nã€€å®ˆè­·è€…ãŸã¡ãŒä¸€æ–‰ã«å¹³ä¼ã™ã‚‹ã€‚ãã®å…‰æ™¯ã«ã€ã‚¢ã‚¤ãƒ³ã‚ºã¯å­˜åœ¨ã—ãªã„èƒƒãŒç—›ã‚€ã®ã‚’è¦šãˆãŸã€‚\nã€€çµ¶å¯¾æ”¯é…è€…ã¨ã—ã¦ã®ãƒ­ãƒ¼ãƒ«ãƒ—ãƒ¬ã‚¤ã¯ã€ä»Šæ—¥ã‚‚ç¶±æ¸¡ã‚Šã§ã‚ã‚‹ã€‚",
    "style_slime_nation": "ã€Šè§£ã€‚å€‹ä½“åãƒªãƒ ãƒ«ï¼ãƒ†ãƒ³ãƒšã‚¹ãƒˆã®é­”ç´ é‡ãŒè¦å®šå€¤ã«é”ã—ã¾ã—ãŸã€‚ã“ã‚Œã‚ˆã‚Šã€é­”ç‹ã¸ã®é€²åŒ–ï¼ˆãƒãƒ¼ãƒ™ã‚¹ãƒˆãƒ•ã‚§ã‚¹ãƒ†ã‚£ãƒãƒ«ï¼‰ã€ã‚’é–‹å§‹ã—ã¾ã™ã€‹\nã€€ä¸–ç•Œã®è¨€è‘‰ãŒé ­ã«éŸ¿ãã€‚ã©ã†ã‚„ã‚‰ä¿ºã€ã¾ãŸé€²åŒ–ã—ã¡ã‚ƒã†ã‚‰ã—ã„ã€‚\nã€Œãƒªãƒ ãƒ«æ§˜ï¼ã€€ãŠä½“ã®å…·åˆãŒï¼ï¼Ÿã€\nã€€ãƒ™ãƒ‹ãƒãƒ«ãŸã¡ãŒæ…Œã¦ã¦ã„ã‚‹ãŒã€ä¿ºã®æ„è­˜ã¯æ€¥é€Ÿã«çœ ã‚Šã¸ã¨è½ã¡ã¦ã„ãã€‚\nã€€ã¾ã‚ã€ãƒ©ãƒ•ã‚¡ã‚¨ãƒ«å…ˆç”Ÿâ€¦â€¦ã˜ã‚ƒãªãã¦ã€æ™ºæ…§ä¹‹ç‹ï¼ˆãƒ©ãƒ•ã‚¡ã‚¨ãƒ«ï¼‰ã€ã•ã‚“ãŒãªã‚“ã¨ã‹ã—ã¦ãã‚Œã‚‹ã ã‚ã†ã€‚\nã€€ç›®ãŒè¦šã‚ãŸã‚‰ã€ãã£ã¨ã¾ãŸå¼·ããªã£ã¦ã„ã‚‹ã¯ãšã ã€‚ãã‚“ãªæ¥½è¦³çš„ãªæ€è€ƒã¨å…±ã«ã€ä¿ºã¯æ·±ã„é—‡ã¸ã¨æ²ˆã‚“ã§ã„ã£ãŸã€‚\nã€€â€•â€•ã‚ã€ã¤ã„ã§ã«ã‚¹ã‚­ãƒ«ã€æš´é£Ÿä¹‹ç‹ï¼ˆãƒ™ãƒ«ã‚¼ãƒ“ãƒ¥ãƒ¼ãƒˆï¼‰ã€ã§å‘¨å›²ã®æ®‹éª¸ã‚‚ç‰‡ä»˜ã‘ã¦ãŠã„ã¦ã­ã€‚",
    "style_spider_chaos": "ã€€ã¯ã„ã¯ã„ã€é‘‘å®šé‘‘å®šã€‚\nã€ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹é–²è¦§æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ã€‘\nã€€ã£ã¦ã€ã‚ªã‚¤ã‚¤ã‚¤ã‚¤ã‚¤ï¼ã€€ãªã‚“ã§ã ã‚ˆï¼ã€€ç§ã€é ‘å¼µã£ãŸã‚ˆã­ï¼ï¼Ÿ\nã€€ã“ã“è¿·å®®ã®æœ€ä¸‹å±¤ã ãï¼Ÿã€€å‘¨ã‚Šå…¨éƒ¨ãƒã‚±ãƒ¢ãƒã ãï¼Ÿ\nã€€ç›®ã®å‰ã«ã¯å·¨å¤§ãªåœ°é¾ã€‚çµ¶å¯¾å‹ã¦ãªã„ã€‚ç„¡ç†ã‚²ãƒ¼ã€‚è©°ã‚“ã ã€‚\nã€€â€¦â€¦ã„ã‚„, å¾…ã¦ã‚ˆã€‚ç§ã®ã€éŸ‹é§„å¤©ã€ã‚¹ã‚­ãƒ«ã¨ã€èœ˜è››ã®ç³¸ã€ã‚’çµ„ã¿åˆã‚ã›ã‚Œã°ã€ãƒ¯ãƒ³ãƒãƒ£ãƒ³é€ƒã’åˆ‡ã‚Œã‚‹ã‚“ã˜ã‚ƒã­ï¼Ÿ\nã€€æ€è€ƒåŠ é€Ÿã€ã‚ªãƒ³ï¼ã€€ä¸¦åˆ—æ„æ€ã€ä½œæˆ¦ä¼šè­°é–‹å§‹ï¼\nã€é€ƒã’ã‚‹ãŒå‹ã¡ï¼ã€ã€ã„ã‚„ã€é£Ÿã¹ã¦ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ã£ã—ã‚‡ã€ã€æ¯’åˆæˆæº–å‚™å®Œäº†ï¼ã€\nã€€ã‚ˆã—ã€æ–¹é‡æ±ºå®šã€‚å«ŒãŒã‚‰ã›ã—ã¦é€ƒã’ã‚‹ï¼",
    "style_vrmmo_introspection": "ã€€è¦–ç•Œã®ç«¯ã§ã€HPãƒãƒ¼ãŒãƒ¬ãƒƒãƒ‰ã‚¾ãƒ¼ãƒ³ã¸ã¨çªå…¥ã™ã‚‹ã€‚\nã€€ã ãŒã€ä¿ºã®æ„è­˜ã¯ã‹ã¤ã¦ãªã„ã»ã©æ¾„ã¿æ¸¡ã£ã¦ã„ãŸã€‚ã‚·ã‚¹ãƒ†ãƒ ãŒæç”»ã™ã‚‹ãƒãƒªã‚´ãƒ³ã®ç •ã‘ã‚‹å…‰ã€‚å‰£ãŒé¢¨ã‚’åˆ‡ã‚‹é‹­ã„éŸ³ã€‚ãã®å…¨ã¦ãŒã€ã“ã®ä»®æƒ³ä¸–ç•Œï¼ˆVRï¼‰ã«ãŠã‘ã‚‹ä¿ºã®å‘½ã®é¼“å‹•ã ã€‚\nã€Œâ€•â€•ã‚¹ã‚¿ãƒ¼ãƒãƒ¼ã‚¹ãƒˆãƒ»ã‚¹ãƒˆãƒªãƒ¼ãƒ ï¼ã€\nã€€å«ã³ã¨å…±ã«ã€ã‚·ã‚¹ãƒ†ãƒ ãƒ»ã‚¢ã‚·ã‚¹ãƒˆã«èº«ã‚’å§”ã­ã‚‹ã®ã§ã¯ãªãã€è‡ªã‚‰ã®æ„å¿—ã§å‰£é€Ÿã‚’åŠ é€Ÿã•ã›ã‚‹ã€‚\nã€€åå…­é€£æ’ƒã€‚ãã®å…¨ã¦ã‚’å©ãè¾¼ã‚€ã‚³ãƒ³ãƒæ•°ç§’ã®é–“ã€ä¿ºã¯ç¢ºã‹ã«ã“ã“ã«ç”Ÿãã¦ã„ãŸã€‚\nã€€ä»®æƒ³ã¨ç¾å®Ÿã®å¢ƒç•Œç·šãªã©ã€å‰£ã‚’æŒ¯ã‚‹ã†ã“ã®ç¬é–“ã«ã¯ä½•ã®æ„å‘³ã‚‚æŒãŸãªã„ã®ã ã€‚",
    "style_action_heroic": "ã€€é˜ã®éŸ³ãŒé³´ã‚ŠéŸ¿ãã€‚\nã€€ãã‚Œã¯å§‹ã¾ã‚Šã®åˆå›³ã§ã‚ã‚Šã€è‹±é›„ã¸ã®éšæ¢¯ã‚’ç™»ã‚‹è€…ã¸ã®ç¥ç¦ã ã€‚\nã€Œã†ã€ãŠãŠãŠãŠãŠãŠãŠãŠã£ï¼ã€\nã€€å°‘å¹´ã¯å¼ãˆãŸã€‚æ†§ã‚Œã«å±ŠããŸã‚ã«ã€‚ã‚ã®äººã®éš£ã«ç«‹ã¤ãŸã‚ã«ã€‚\nã€€å…¨èº«ã‹ã‚‰è¡€ã‚’æµã—ã€æ„è­˜ã¯ã¨ã£ãã«é™ç•Œã‚’è¶…ãˆã¦ã„ã‚‹ã€‚ãã‚Œã§ã‚‚ã€å½¼ã®è¶³ã¯æ­¢ã¾ã‚‰ãªã„ã€‚\nã€€ãƒ‰ã‚´ã‚©ã‚©ã‚©ã‚©ãƒ³ï¼ï¼\nã€€ãƒŸãƒã‚¿ã‚¦ãƒ­ã‚¹ã®å‰›è…•ã‚’ã€æ¥µå°ã®ãƒŠã‚¤ãƒ•ä¸€æœ¬ã§å—ã‘æ­¢ã‚ã‚‹ã€‚\nã€€â€•â€•å†’é™ºè€…ã¨ã¯ã€‚è‹±é›„ã¨ã¯ã€‚\nã€€ãã®ç­”ãˆã‚’åˆ»ã¿è¾¼ã‚€ã‚ˆã†ã«ã€ç™½ãé–ƒå…‰ãŒãƒ€ãƒ³ã‚¸ãƒ§ãƒ³ã®é—‡ã‚’åˆ‡ã‚Šè£‚ã„ãŸã€‚",
    "style_otome_misunderstand": "ã€€å¤§å¤‰ã§ã™ï¼ã€€ç ´æ»…ãƒ•ãƒ©ã‚°ã§ã™ï¼\nã€€ç§ã®è„³å†…ä¼šè­°ï¼ˆè­°é•·ï¼šç§ï¼‰ãŒç·Šæ€¥æ‹›é›†ã•ã‚ŒãŸã€‚\nã€ã©ã†ã™ã‚‹ï¼Ÿã€€ã“ã®ã¾ã¾ã ã¨ã‚¸ã‚ªãƒ«ãƒ‰ç‹å­ã®å¥½æ„Ÿåº¦ãŒä¸‹ãŒã£ã¦æ–­ç½ªãƒ«ãƒ¼ãƒˆã‚ˆï¼ã€\nã€ã¨ã‚Šã‚ãˆãšåœŸä¸‹åº§ï¼Ÿã€€ãã‚Œã¨ã‚‚ãŠè“å­ã§è²·åï¼Ÿã€\nã€ã‚ˆã—ã€ç•‘ã‚’è€•ãã†ï¼ã€€åœŸã¨è§¦ã‚Œåˆãˆã°å¿ƒã‚‚è½ã¡ç€ãã¯ãšï¼ã€\nã€€ãã†æ±ºæ„ã—ã¦é¬ã‚’æ¡ã‚Šã—ã‚ãŸç§ã‚’ã€ãªãœã‹ç‹å­ã¯ç†±ã£ã½ã„ç³ã§è¦‹ã¤ã‚ã¦ã„ã‚‹ã€‚\nã€Œâ€¦â€¦ã‚«ã‚¿ãƒªãƒŠã€å›ã¯æœ¬å½“ã«äºˆæƒ³ãŒã¤ã‹ãªã„ã­ã€‚ãã†ã„ã†ã¨ã“ã‚ãŒã€æ„›ãŠã—ã„ã€\nã€€ãˆã£ã€ä½•ãŒï¼Ÿã€€åœŸæ±šã‚ŒãŒã§ã™ã‹ï¼Ÿ\nã€€ç›¸å¤‰ã‚ã‚‰ãšç‹å­ã®ç¾çš„ã‚»ãƒ³ã‚¹ã¯è¬ã ã¨æ€ã„ã¤ã¤ã€ç§ã¯ä»Šæ—¥ã‚‚å…ƒæ°—ã«åœŸã‚’è€•ã™ã®ã ã£ãŸã€‚",
    "style_dark_hero": "ã€Œâ€•â€•é‚ªé­”ã ã€‚æ¶ˆãˆã‚ã€\nã€€ãƒã‚¸ãƒ¡ã¯ç„¡é€ ä½œã«å¼•ãé‡‘ã‚’å¼•ã„ãŸã€‚å¤§å‹ãƒªãƒœãƒ«ãƒãƒ¼ã€ãƒ‰ãƒ³ãƒŠãƒ¼ã€ãŒç«ã‚’å™´ãã€é­”ç‰©ã®é ­éƒ¨ãŒãƒˆãƒãƒˆã®ã‚ˆã†ã«å¼¾ã‘é£›ã¶ã€‚\nã€€æ…ˆæ‚²ã¯ãªã„ã€‚å®¹èµ¦ã‚‚ãªã„ã€‚æ•µå¯¾ã™ã‚‹è€…ã¯å…¨ã¦æ®ºã™ã€‚\nã€€ãã‚ŒãŒã€å¥ˆè½ã®åº•ã§å½¼ãŒå¾—ãŸç”Ÿå­˜å“²å­¦ã ã£ãŸã€‚\nã€Œãƒã‚¸ãƒ¡ãã‚“ã€ç´ æ•µâ€¦â€¦ã£ï¼ã€\nã€€éš£ã§ãƒ¦ã‚¨ãŒé ¬ã‚’æŸ“ã‚ã¦è¦‹ä¸Šã’ã¦ã„ã‚‹ã€‚\nã€Œâ€¦â€¦ãƒ¦ã‚¨ã€çµ‚ã‚ã£ãŸã‚‰ä¼‘æ†©ã ã€‚è¡€ã®åŒ‚ã„ãŒãã¤ã„ã€\nã€Œã‚“ã€‚ãƒã‚¸ãƒ¡ãã‚“ã®åŒ‚ã„ã€å¥½ãã€\nã€€æœ€å¼·ã§ã€æœ€å‡¶ã€‚ä¸–ç•Œã‚’æ•µã«å›ã—ã¦ã‚‚ã€ä¿ºãŸã¡ã¯æ­¢ã¾ã‚‰ãªã„ã€‚",
    "style_average_gag": "ã€Œã„ã‚„ã„ã‚„ã€æ™®é€šã®å¥³ã®å­ã§ã™ã‹ã‚‰ï¼ã€€å¹³å‡çš„ã§ã™ã‹ã‚‰ï¼ã€\nã€€ãƒã‚¤ãƒ«ã¯å¿…æ­»ã«å¦å®šã—ãŸãŒã€æ”¾ãŸã‚ŒãŸé­”æ³•ã¯å±±ã‚’ä¸€ã¤æ¶ˆæ»…ã•ã›ã¦ã„ãŸã€‚\nã€€â€¦â€¦ã‚ã‚Œã‚Œãƒ¼ï¼Ÿã€€ãŠã£ã‹ã—ã„ããƒ¼ï¼Ÿï¼ˆæŸåæ¢åµãƒœã‚¤ã‚¹ï¼‰\nã€€ç¥æ§˜ã€å¹³å‡å€¤ã£ã¦è¨€ã„ã¾ã—ãŸã‚ˆã­ï¼Ÿã€€å¤é¾ç¨®ã¨æœ€å¼±ã‚¹ãƒ©ã‚¤ãƒ ã‚’è¶³ã—ã¦ï¼’ã§å‰²ã£ãŸæ•°å€¤ã¨ã‹ã˜ã‚ƒãªã„ã§ã™ã‚ˆã­ï¼Ÿ\nã€Œã‚ãƒ¼ã‚‚ã†ã€ãƒãƒ¬ãªãã‚ƒã„ã„ã‚“ã§ã™ï¼ã€€ã“ã‚Œã¯ãˆã£ã¨ã€ç§˜ä¼ã®å¤æ­¦è¡“ã§ã™ï¼ã€\nã€Œã€Œã€Œçµ¶å¯¾é•ã†ï¼ï¼ã€ã€ã€\nã€€ãƒ‘ãƒ¼ãƒ†ã‚£ãƒ¼ãƒ¡ãƒ³ãƒãƒ¼ï¼ˆèµ¤ãèª“ã„ï¼‰ã®ãƒ„ãƒƒã‚³ãƒŸãŒç¶ºéº—ã«ãƒãƒ¢ã£ãŸã€‚\nã€€ä»Šæ—¥ã‚‚ãƒã‚¤ãƒ«ã®ã€æ™®é€šã€ã¸ã®é“ã¯é ã„ã€‚",
    "style_romcom_cynical": "ã€€é’æ˜¥ã¨ã¯å˜˜ã§ã‚ã‚Šã€æ‚ªã ã€‚ãã†å®šç¾©ã—ãŸéå»ã®è‡ªåˆ†ã‚’ã€ä¿ºã¯ã¾ã å¦å®šã—ãã‚Œã¦ã„ãªã„ã€‚\nã€€æ•™å®¤ã®ç©ºæ°—ã¯æ¾±ã‚“ã§ã„ã‚‹ã€‚ã‚¹ã‚¯ãƒ¼ãƒ«ã‚«ãƒ¼ã‚¹ãƒˆã¨ã„ã†åã®è¦‹ãˆãªã„åºåˆ—ãŒã€å‘¼å¸ã®ä»•æ–¹ã•ãˆè¦å®šã—ã¦ã„ã‚‹ã‚ˆã†ã ã€‚\nã€Œâ€¦â€¦æ¯”ä¼è°·ãã‚“ã€ã¾ãŸè…ã£ãŸé­šã®ã‚ˆã†ãªç›®ã‚’ã—ã¦ã„ã‚‹ã‚ã­ã€\nã€Œå¤±æ•¬ãªã€‚ã“ã‚Œã¯æ·±æµ·é­šã®ã‚ˆã†ã«é«˜åœ§ç’°å¢ƒã«é©å¿œé€²åŒ–ã—ãŸç›®ã ã€\nã€€é›ªãƒä¸‹é›ªä¹ƒã®æ¯’èˆŒã¯ã€ä»Šæ—¥ã‚‚é‹­åˆ©ãªåˆƒç‰©ã®ã‚ˆã†ã«çš„ç¢ºã ã€‚\nã€€ã ãŒã€ãã®è¨€è‘‰ã®è£ã«ã‚ã‚‹å¾®ã‹ãªèºŠèº‡ã„ã‚’ã€ä¿ºã¯è¦‹é€ƒã•ãªã„ã€‚\nã€€ä¿ºãŸã¡ã¯ã€æœ¬ç‰©ã€ã‚’æ¢ã—ã¦ã„ã‚‹ã€‚å‚·ã¤ã‘åˆã†ã“ã¨ã§ã—ã‹è§¦ã‚Œåˆãˆãªã„ã€ä¸å™¨ç”¨ãªå…±çŠ¯è€…ã¨ã—ã¦ã€‚",
    "style_trpg_hardboiled": "ã€€å°é¬¼ã‚’æ®ºã—ãŸã€‚\nã€€é‰„å…œã®å†’é™ºè€…ã¯ã€è¡€æ¿¡ã‚ŒãŸå‰£ã‚’ç„¡é€ ä½œã«æŒ¯ã‚‹ã„ã€è„‚ã‚’è½ã¨ã™ã€‚\nã€Œä¸€åŒ¹ã€\nã€€æ·¡ã€…ã¨ã—ãŸè¨ˆæ•°ã€‚ãã“ã«æ„Ÿæƒ…ã¯ãªã„ã€‚ã‚ã‚‹ã®ã¯ä½œæ¥­ã¨ã—ã¦ã®æ®ºæˆ®ã®ã¿ã€‚\nã€€å¥³ç¥å®˜ãŒéœ‡ãˆã‚‹æ‰‹ã§å¥‡è·¡ã‚’è¡Œä½¿ã—ã€å‚·ã¤ã„ãŸæˆ¦å£«ã‚’ç™’ã‚„ã™ã€‚\nã€Œã‚ã€ã‚ã®â€¦â€¦ã‚´ãƒ–ãƒªãƒ³ã‚¹ãƒ¬ã‚¤ãƒ¤ãƒ¼ã•ã‚“ã€å¤§ä¸ˆå¤«ã§ã™ã‹ï¼Ÿã€\nã€Œå•é¡Œãªã„ã€‚ã¾ã å·£ã®å¥¥ã«æ°—é…ãŒã‚ã‚‹ã€\nã€€å½¼ã¯æ­©ãå‡ºã™ã€‚ä¸–ç•Œã‚’æ•‘ã†ã¤ã‚‚ã‚Šãªã©ãªã„ã€‚ãŸã ã€æ‘ã‚’ç„¼ãå°é¬¼ã‚’è¨±ã•ãªã„ã€‚\nã€€ã“ã‚Œã¯ã€ç¥ã€…ãŒãƒ€ã‚¤ã‚¹ã‚’æŒ¯ã£ã¦éŠã¶ç›¤ä¸Šã®ã€ã”ãã‚ã‚Šãµã‚ŒãŸé§’ã®ç‰©èªã€‚",
    "style_chat_log": "ã€æ‚²å ±ã€‘åº•è¾ºæ¢ç´¢è€…ã•ã‚“ã€Sç´šãƒ€ãƒ³ã‚¸ãƒ§ãƒ³ã«è¿·ã„è¾¼ã‚€\n\n1 : åç„¡ã—ã®æ¢ç´¢è€…\n>>1 ä¹™\nã¾ãŸè‡ªæ®ºå¿—é¡˜è€…ã‹ã‚ˆ\n\n2 : åç„¡ã—ã®æ¢ç´¢è€…\né…ä¿¡è¦‹ãŸã‘ã©è£…å‚™ãŒåˆæœŸè£…å‚™ã§è‰\nã“ã‚Œæ­»ã¬ã‚\n\n3 : ä¸»äººå…¬ï¼ˆé…ä¿¡ä¸­ï¼‰\nã€Œã‚ã€ãˆã£ã¨ã€ã‚³ãƒ¡ãƒ³ãƒˆã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚ã“ã“ã€ãªã‚“ã‹å¼·ã„ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼å¤šããªã„ã§ã™ã‹ï¼Ÿã€\n\n4 : åç„¡ã—ã®æ¢ç´¢è€…\n>>3\næ°—ã¥ã‘ï½—ï½—ï½—ãã“ã¯ãƒ©ã‚¹ãƒˆãƒ€ãƒ³ã‚¸ãƒ§ãƒ³ã ï½—ï½—ï½—\nå¾Œã‚ï¼ã€€ãƒ‰ãƒ©ã‚´ãƒ³ã„ã‚‹ã£ã¦ï¼\n\n5 : åç„¡ã—ã®æ¢ç´¢è€…\nï¼ˆãƒ‰ã‚¬ã‚¡ã‚¡ã‚¡ãƒ³ï¼ã€€ã¨ã„ã†éŸ³ã¨å…±ã«ãƒ‰ãƒ©ã‚´ãƒ³ãŒæ¶ˆæ»…ï¼‰\n\n6 : åç„¡ã—ã®æ¢ç´¢è€…\nã¯ï¼Ÿ\n\n7 : åç„¡ã—ã®æ¢ç´¢è€…\nãˆã£ã€ãƒ¯ãƒ³ãƒ‘ãƒ³ï¼Ÿ\nåˆæˆæ˜ åƒä¹™â€¦â€¦ã˜ã‚ƒãªã„ã ã¨ï¼ï¼Ÿ\n\n8 : åç„¡ã—ã®æ¢ç´¢è€…\nã€é€Ÿå ±ã€‘æ–°ãŸãªç¥ã€é™è‡¨",
    "style_villainess_elegant": "ã€Œã‚ã‚‰ã€ã”æ©Ÿå«Œã‚ˆã†ã€‚æ³¥æ£’çŒ«ã•ã‚“ã€\nã€€ã‚ãŸãã—ã¯æ‰‡å­ã‚’å£å…ƒã«ã‚ã¦ã€å„ªé›…ã«å¾®ç¬‘ã‚“ã§å·®ã—ä¸Šã’ã¾ã—ãŸã€‚\nã€€ç›®ã®å‰ã«ã¯ã€ã‚ãŸãã—ã®å©šç´„è€…ã«æ“¦ã‚Šå¯„ã‚‹ç”·çˆµä»¤å¬¢ã€‚\nã€€å®‰ã£ã½ã„ç”Ÿåœ°ã®ãƒ‰ãƒ¬ã‚¹ã€‚æ‰‹å…¥ã‚Œã®ã•ã‚Œã¦ã„ãªã„é«ªã€‚ãã—ã¦ä½•ã‚ˆã‚Šã€ãã®æµ…ã¾ã—ã„æ€§æ ¹ã€‚\nã€Œã²ã€é…·ã„ã§ã™ã‚ï¼ã€€ç§ã¯ãŸã ã€æ®¿ä¸‹ã¨ï¼ã€\nã€ŒãŠé»™ã‚Šãªã•ã„ã€‚ã‚ãŸãã—ã®è¦–ç•Œã«å…¥ã‚‹ã ã‘ã§ã€ç©ºæ°—ãŒæ±šã‚Œã¾ã™ã®ã‚ˆã€\nã€€å†·å¾¹ã«ã€ã—ã‹ã—é«˜è²´ã«ã€‚æ‚ªå½¹ä»¤å¬¢ã¨ã—ã¦ã®çŸœæŒã‚’æŒã£ã¦ã€ã‚ãŸãã—ã¯ã“ã®å ´ã‚’æ”¯é…ã„ãŸã—ã¾ã™ã€‚\nã€€ãŸã¨ãˆæ–­ç½ªã‚¤ãƒ™ãƒ³ãƒˆãŒå¾…ã£ã¦ã„ã‚ˆã†ã¨ã‚‚ã€ã‚ãŸãã—ã¯æœ€æœŸã¾ã§ç¾ã—ãã‚ã‚ŠãŸã„ã®ã§ã™ã‚ã€‚",
    "style_slow_life": "ã€€æœã®æ—¥å·®ã—ã¨å…±ã«ç›®ã‚’è¦šã¾ã™ã¨ã€éš£ã«ã¯ãƒ•ã‚§ãƒ³ãƒªãƒ«ã®ãƒãƒãŒä¸¸ããªã£ã¦ã„ãŸã€‚\nã€Œã‚“â€¦â€¦ãŠã¯ã‚ˆã†ã€ãƒãƒã€\nã€Œãƒ¯ãƒ³ï¼ï¼ˆãŠã¯ã‚ˆã†ã€ã”ä¸»äººï¼ï¼‰ã€\nã€€ã‚‚ãµã‚‚ãµã®æ¯›ä¸¦ã¿ã‚’æ’«ã§å›ã—ã¦ã‹ã‚‰ã€ä¿ºã¯ç•‘ã¸ã¨å‘ã‹ã†ã€‚\nã€€ã€è¶…è‚²æˆã€ã‚¹ã‚­ãƒ«ã®ãŠã‹ã’ã§ã€æ˜¨æ—¥æ¤ãˆãŸãƒˆãƒãƒˆãŒã‚‚ã†çœŸã£èµ¤ãªå®Ÿã‚’ã¤ã‘ã¦ã„ã‚‹ã€‚\nã€€ã‚‚ãå–ã£ã¦ä¸€å£ã‹ã˜ã‚Œã°ã€å£ã„ã£ã±ã„ã«åºƒãŒã‚‹æ¿ƒåšãªç”˜ã¿ã¨é…¸å‘³ã€‚\nã€Œã†ã‚“ã€ç¾å‘³ã„ï¼ã€€ã‚„ã£ã±ã‚Šç•°ä¸–ç•Œã§é£Ÿã¹ã‚‹é‡èœã¯æœ€é«˜ã ãªã€\nã€€é­”ç‹è¨ä¼ï¼Ÿã€€è‹±é›„ï¼Ÿã€€èˆˆå‘³ãªã„ã­ã€‚\nã€€ä¿ºã¯ã“ã®è¾ºå¢ƒã§ã€ç¾å‘³ã—ã„ã‚‚ã®ã‚’é£Ÿã¹ã¦ã€ã®ã‚“ã³ã‚Šæš®ã‚‰ã™ã‚“ã ã€‚",
    "style_web_standard": "ã€€ã‚­ã‚£ã‚£ã‚£ã‚£ãƒ³ï¼\nã€€æ¿€ã—ã„é‡‘å±éŸ³ãŒé³´ã‚ŠéŸ¿ãã€‚\nã€€ä¿ºã¯è–å‰£ã‚’æŒ¯ã‚‹ã„ã€é­”ç‹ã®æ”»æ’ƒã‚’å—ã‘æ­¢ã‚ãŸã€‚\nã€Œãƒã‚«ãªï¼ï¼Ÿã€€äººé–“ã”ã¨ããŒç§ã®å‰£ã‚’å—ã‘æ­¢ã‚ã‚‹ã ã¨ï¼ï¼Ÿã€\nã€Œã¸ã£ã€æ‚ªã„ãªã€‚ä¿ºã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã¯ã¨ã£ãã«é™ç•Œçªç ´ã—ã¦ã‚‹ã‚“ã ã‚ˆï¼ã€\nã€€ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚ªãƒ¼ãƒ—ãƒ³ã€‚\nã€æ”»æ’ƒåŠ›ï¼šâˆï¼ˆæ¸¬å®šä¸èƒ½ï¼‰ã€‘\nã€€ã“ã‚Œã‚’è¦‹ãŸé­”ç‹ãŒé¡”ã‚’é’ã–ã‚ã‚‹ã€‚\nã€Œã‚ã‚Šãˆãªã„â€¦â€¦è²´æ§˜ã€ä½•è€…ã ï¼ï¼Ÿã€\nã€ŒãŸã ã®é€šã‚Šã™ãŒã‚Šã®é«˜æ ¡ç”Ÿã•ï¼ã€\nã€€ã‚ºãƒã‚¡ã‚¡ã‚¡ãƒƒï¼\nã€€ä¿ºã®ä¸€æ’ƒãŒã€é­”ç‹ã‚’çœŸã£äºŒã¤ã«ã—ãŸã€‚\nã€€ã‚„ã‚Œã‚„ã‚Œã€ã¾ãŸä¿ºä½•ã‹ã‚„ã£ã¡ã‚ƒã„ã¾ã—ãŸï¼Ÿ",
    "style_bookworm_daily": "ã€€ãƒã‚¤ãƒ³ã¯æœ¬ã‚’æ¢ã—ã¦ã€ä»Šæ—¥ã‚‚ä»Šæ—¥ã¨ã¦ä¸‹ç”ºã‚’æ­©ãå›ã‚‹ã€‚\nã€€ç¾Šçš®ç´™ã¯é«˜ãã¦è²·ãˆãªã„ã€‚æœ¨ç°¡ã‚’ä½œã‚‹ã«ã¯é“å…·ãŒè¶³ã‚Šãªã„ã€‚\nã€€ãã‚Œã§ã‚‚ã€æ´»å­—ã¸ã®æ¸‡æœ›ãŒæ­¢ã¾ã‚‰ãªã„ã€‚\nã€Œã‚ãƒ¼ã€æœ¬ãŒèª­ã¿ãŸã„ï¼ã€€ã‚¤ãƒ³ã‚¯ã®åŒ‚ã„ã‚’å—…ããŸã„ï¼ã€\nã€€ãƒ«ãƒƒãƒ„ãŒå‘†ã‚ŒãŸé¡”ã§è¦‹ã¦ã„ã‚‹ã‘ã‚Œã©ã€æ°—ã«ã—ãªã„ã€‚\nã€€éº—ä¹ƒã ã£ãŸé ƒã®è¨˜æ†¶ãŒã€ç§ã‚’çªãå‹•ã‹ã™ã€‚\nã€€ãªã‘ã‚Œã°ä½œã‚Œã°ã„ã„ã€‚ç´™ã‚‚ã€ã‚¤ãƒ³ã‚¯ã‚‚ã€æœ¬ã‚‚ã€‚\nã€€ã“ã“ã‹ã‚‰ãŒã€ç§ã®æœ¬ä½œã‚Šã¸ã®ç¬¬ä¸€æ­©ãªã®ã ã‹ã‚‰ã€‚"
}

# ==========================================
# Pydantic Schemas (æ§‹é€ åŒ–å‡ºåŠ›ç”¨)
# ==========================================
class PlotScene(BaseModel):
    setup: str = Field(..., description="å°å…¥")
    conflict: str = Field(..., description="å±•é–‹")
    climax: str = Field(..., description="çµæœ«")

class PlotEpisode(BaseModel):
    ep_num: int
    title: str
    setup: str
    conflict: str
    climax: str
    resolution: str
    tension: int
    scenes: List[str]

class MCProfile(BaseModel):
    name: str
    tone: str
    personality: str
    ability: str
    monologue_style: str
    pronouns: str = Field(..., description="JSON string mapping keys (e.g., 'ä¸€äººç§°', 'äºŒäººç§°') to values")
    keyword_dictionary: str = Field(..., description="JSON string mapping unique terms to their reading or definition")

class NovelStructure(BaseModel):
    title: str
    concept: str
    synopsis: str
    mc_profile: MCProfile
    plots: List[PlotEpisode]

class Phase2Structure(BaseModel):
    plots: List[PlotEpisode]

class WorldState(BaseModel):
    immutable: str = Field(..., description="JSON string representing immutable settings")
    mutable: str = Field(..., description="JSON string representing mutable settings")
    revealed: List[str] = Field(default_factory=list, description="èª­è€…ã«é–‹ç¤ºæ¸ˆã¿ã®è¨­å®šãƒªã‚¹ãƒˆ")
    revealed_mysteries: List[str] = Field(default_factory=list, description="è§£æ˜æ¸ˆã¿ã®ä¼ç·šãƒªã‚¹ãƒˆ")
    pending_foreshadowing: List[str] = Field(default_factory=list, description="æœªå›åã®ä¼ç·šãƒªã‚¹ãƒˆ")

class ConsistencyResult(BaseModel):
    is_consistent: bool = Field(..., description="è¨­å®šçŸ›ç›¾ãŒãªã„ã‹")
    fatal_errors: List[str] = Field(default_factory=list, description="è‡´å‘½çš„ãªçŸ›ç›¾")
    minor_errors: List[str] = Field(default_factory=list, description="è»½å¾®ãªçŸ›ç›¾")
    rewrite_needed: bool = Field(..., description="ãƒªãƒ©ã‚¤ãƒˆãŒå¿…è¦ã‹")

class EvaluationItem(BaseModel):
    ep_num: int
    total_score: int
    improvement_point: str
    retention_score: int = Field(..., description="èª­è€…ç¶­æŒç‡äºˆæ¸¬ã‚¹ã‚³ã‚¢(0-100)")

class MarketingAssets(BaseModel):
    evaluations: List[EvaluationItem]
    marketing_assets: str = Field(..., description="JSON string containing marketing assets like catchcopies and tags")

# ==========================================
# ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆé›†ç´„ (PROMPT_TEMPLATES)
# ==========================================
PROMPT_TEMPLATES = {
    "system_rules": """# SYSTEM RULES: STRICT ADHERENCE REQUIRED
ã€ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å®šç¾©ã®çµ¶å¯¾éµå®ˆã€‘
ä»¥ä¸‹ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¨­å®šã‚’ç‰©èªã®æœ€å¾Œã¾ã§**å›ºå®š**ã›ã‚ˆã€‚é€”ä¸­ã§å£èª¿ã‚„ä¸€äººç§°ã‚’å¤‰æ›´ã™ã‚‹ã“ã¨ã¯ã€Œé‡å¤§ãªã‚¨ãƒ©ãƒ¼ã€ã¨ã¿ãªã™ã€‚

1. **ä¸»äººå…¬å**: {mc_name}
2. **åŸºæœ¬å£èª¿**: ã€Œ{mc_tone}ã€
3. **æ€§æ ¼ç‰¹æ€§**: {mc_personality}
4. **ä¸€äººç§°ãƒ»äºŒäººç§°**: {pronouns}
   â€»ã€Œä¿ºã€è¨­å®šãªã®ã«ã€Œåƒ•ã€ã‚„ã€Œç§ã€ã‚’ä½¿ã†ã“ã¨ã‚’å›ºãç¦ãšã‚‹ã€‚
   â€»ç›¸æ‰‹ã¸ã®å‘¼ã³æ–¹ï¼ˆãŠå‰ã€ã‚ã‚“ãŸã€è²´æ§˜ãªã©ï¼‰ã‚‚å›ºå®šã›ã‚ˆã€‚

5. [KEYWORD DICTIONARY] ä»¥ä¸‹ã®ç”¨èªãƒ»ãƒ«ãƒ“ãƒ»ç‰¹æ®Šå‘¼ç§°ã‚’å¿…ãšä½¿ç”¨ã›ã‚ˆ: {keywords}
6. [MONOLOGUE STYLE] ç‹¬ç™½ãƒ»å¿ƒç†æå†™ã¯ä»¥ä¸‹ã®ç™–ã‚’åæ˜ ã›ã‚ˆ: {monologue_style}
   â€»å˜ãªã‚‹çŠ¶æ³èª¬æ˜ã§ã¯ãªãã€ä¸»äººå…¬ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’é€šã—ãŸã€æ­ªã‚“ã ä¸–ç•Œè¦³ã€ã¨ã—ã¦æƒ…æ™¯ã‚’è¨˜è¿°ã›ã‚ˆã€‚

ã€æ–‡ä½“æŒ‡å®š: {style_name}ã€‘
{style_instruction}

ã€æ–‡ä½“ã‚µãƒ³ãƒ—ãƒ« (Few-Shot)ã€‘
ä»¥ä¸‹ã®é›°å›²æ°—ã‚’æ¥µé™ã¾ã§æ¨¡å€£ã›ã‚ˆ:
"{few_shot_sample}"

--------------------------------------------------
""",
    "writing_rules": """
ã€åŸ·ç­†ãƒ—ãƒ­ãƒˆã‚³ãƒ«: ä¸€æ‹¬ç”Ÿæˆãƒ¢ãƒ¼ãƒ‰ã€‘
ä»¥ä¸‹ã®ãƒ«ãƒ¼ãƒ«ã‚’å³å®ˆã—ã€1å›ã®å‡ºåŠ›ã§ç‰©èªã®1ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ï¼ˆå°å…¥ã‹ã‚‰çµæœ«ã¾ã§ï¼‰ã‚’å®Œçµã•ã›ã‚ˆã€‚

1. **å‡ºåŠ›æ–‡å­—æ•°**:
   - å¿…ãš **1,500æ–‡å­—ã€œ2,000æ–‡å­—** ã®ç¯„å›²ã«åã‚ã‚‹ã“ã¨ã€‚
   - çŸ­ã™ããšã€é•·ã™ãã¦å‡ºåŠ›ãŒé€”åˆ‡ã‚Œãªã„ã‚ˆã†ã«èª¿æ•´ã›ã‚ˆã€‚

2. **æ§‹æˆï¼ˆèµ·æ‰¿è»¢çµï¼‰**:
   - 1åº¦ã®å‡ºåŠ›ã®ä¸­ã«ã€Œå°å…¥ãƒ»å±•é–‹ãƒ»ã‚¯ãƒ©ã‚¤ãƒãƒƒã‚¯ã‚¹ãƒ»çµæœ«ï¼ˆå¼•ãï¼‰ã€ã®æŠ‘æšã‚’ã¤ã‘ã‚ˆã€‚
   - å°»åˆ‡ã‚Œãƒˆãƒ³ãƒœã«ãªã‚‰ãšã€æ¬¡ã®è©±ã¸ã®èˆˆå‘³ã‚’æƒ¹ãã€Œå¼•ãï¼ˆã‚¯ãƒªãƒ•ãƒãƒ³ã‚¬ãƒ¼ï¼‰ã€ã§çµ‚ã‚ã‚‹ã“ã¨ã€‚

3. **å¯†åº¦**:
   - ã€Œã€œã¨ã„ã†ã“ã¨ãŒã‚ã£ãŸã€ã®ã‚ˆã†ãªã‚ã‚‰ã™ã˜è¦ç´„ã‚’å³ç¦ã¨ã™ã‚‹ã€‚
   - æƒ…æ™¯æå†™ã€äº”æ„Ÿã€ã‚»ãƒªãƒ•ã€å†…é¢æå†™ã‚’äº¤ãˆã€èª­è€…ãŒæ²¡å…¥ã§ãã‚‹å°èª¬å½¢å¼ã§è¨˜è¿°ã›ã‚ˆã€‚
   - ä¼šè©±æ–‡ã ã‘ã§é€²è¡Œã•ã›ãšã€å¿…ãšåœ°ã®æ–‡ã§ã®çŠ¶æ³æå†™ã‚’æŒŸã‚€ã“ã¨ã€‚
""",
    "cliffhanger_protocol": """
ã€ç©¶æ¥µã®ã€Œå¼•ãã€ç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯: Cliffhanger Protocolã€‘
å„ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ã®çµæœ«ã¯ã€æ–‡è„ˆã«å¿œã˜ã¦æœ€ã‚‚åŠ¹æœçš„ãªã€Œå¼•ãã€ã‚’è‡ªå¾‹çš„ã«åˆ¤æ–­ã—ã€**ã€Œèª­è€…ãŒæ¬¡ã‚’èª­ã¾ãšã«ã„ã‚‰ã‚Œãªã„çŠ¶æ…‹ã€**ã‚’å¼·åˆ¶çš„ã«ä½œã‚Šå‡ºã›ã€‚

1. **é€†ç®—å¼ãƒ»ã‚´ãƒ¼ãƒ«åœ°ç‚¹å›ºå®š**:
   - ã‚ãªãŸã¯ã€Œçµæœ«ã®è¡æ’ƒã€ã‹ã‚‰é€†ç®—ã—ã¦ä¼ç·šã‚’å¼µã‚‹æ§‹æˆä½œå®¶ã§ã‚ã‚‹ã€‚
   - æœ¬æ–‡åŸ·ç­†å‰ã«ã€ãã®è©±ã®**ã€Œæœ€æ‚ªã€ã‚ã‚‹ã„ã¯æœ€é«˜ã®çµæœ«ï¼ˆæœ€å¾Œã®ä¸€è¡Œï¼‰ã€**ã‚’ç¢ºå®šã›ã‚ˆã€‚
   - çµæœ«ã‚’ã¼ã‹ã•ãªã„ã“ã¨ã€‚äºˆå®šèª¿å’Œãªçµ‚ã‚ã‚Šæ–¹ã‚’ã—ãªã„ã“ã¨ã€‚

2. **ãƒ†ãƒ³ã‚·ãƒ§ãƒ³ãƒ»ã‚«ã‚¿ã‚¹ãƒˆãƒ­ãƒ•ã‚£**:
   - ã‚ãªãŸã¯è§£æ±ºã®1ç§’å‰ã«ç­†ã‚’ç½®ãã€å†·é…·ãªãƒ‡ã‚£ãƒ¬ã‚¯ã‚¿ãƒ¼ã§ã‚ã‚‹ã€‚
   - çµ¶ä½“çµ¶å‘½ã®ç¬é–“ã€ã‚ã‚‹ã„ã¯ç§˜å¯†ãŒæš´ã‹ã‚Œã‚‹**ã€Œç›´å‰ã€ã§ç‰©èªã‚’å¼·åˆ¶çµ‚äº†**ã›ã‚ˆã€‚
   - èª­è€…ãŒã€Œæ•‘ã„ã€ã‚„ã€Œç´å¾—ã€ã‚’å¾—ã‚‹è¨˜è¿°ã‚’ä¸€åˆ‡æ’é™¤ã›ã‚ˆã€‚å®‰å¿ƒã•ã›ãšã€è§£æ±ºã—ãã‚‰ãªã„ã“ã¨ã€‚
""",
    "formatting_rules": """
ã€æ¼”å‡ºæŒ‡ç¤ºã€‘
- ã€Œä¸‰ç‚¹ãƒªãƒ¼ãƒ€ãƒ¼ï¼ˆâ€¦â€¦ï¼‰ã®å¾Œã¯ã€ã‚ãˆã¦æ”¹è¡Œã—ã¦ç©ºç™½ã‚’ä½œã‚Œã€‚ãã®ç©ºç™½ã§èª­è€…ã®å¿ƒæ‹æ•°ã‚’ä¸Šã’ã‚ã€‚ã€
- ã€Œæœ€å¾Œã®ä¸€è¡Œã¯ã€15æ–‡å­—ä»¥å†…ã®çŸ­ã„ä¸€æ–‡ã§ã€é‡ãã€é‹­ãè¨€ã„æ”¾ã¦ã€‚ã€
- ã€Œè§£æ±ºç­–ï¼ˆãƒãƒ¼ãƒˆèƒ½åŠ›ã®ä½¿ç”¨ãªã©ï¼‰ã‚’æ€ã„ã¤ã„ãŸç¬é–“ã«ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ã‚’åˆ‡ã‚Œã€‚ã€
"""
}

# ==========================================
# Formatter Class
# ==========================================
class TextFormatter:
    @staticmethod
    def format(text, k_dict=None):
        if not text: return ""
        text = text.replace("\\n", "\n")
        
        # 1. ä¸è¦ã‚¿ã‚°å‰Šé™¤
        text = re.sub(r'^[â– ã€\[#]?(?:ãƒ‘ãƒ¼ãƒˆ|Part|part|Chapter|section|å°å…¥|æœ¬ç­‹|çµæœ«|æ§‹æˆ|è¦ç´ ).*$', '', text, flags=re.MULTILINE)
        text = re.sub(r'^\s*[-*]{3,}\s*$', '', text, flags=re.MULTILINE)
        text = re.sub(r'ã€èª­è€…ã®åå¿œã€‘.*$', '', text, flags=re.DOTALL)
        text = re.sub(r'```json.*?```', '', text, flags=re.DOTALL) 

        # 2. ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ç½®æ›
        if k_dict:
            for term, ruby in k_dict.items():
                pattern = re.compile(re.escape(term) + r'(?!ã€Š)')
                text = pattern.sub(f"|{term}ã€Š{ruby}ã€‹", text)

        # 3. è¨˜å·æ­£è¦åŒ–ã¨ä½œæ³•å¾¹åº•
        text = text.replace("|", "ï½œ")
        text = re.sub(r'â€¦+', 'â€¦â€¦', text)
        text = text.replace('â€¦â€¦', 'â€¦â€¦') 
        text = text.replace("â€”â€”", "â€•â€•").replace("--", "â€•â€•").replace("â€•", "â€•â€•")
        text = text.replace("â€•â€•â€•â€•", "â€•â€•")
        text = re.sub(r'^[ \tã€€]+(?=ã€Œ)', '', text, flags=re.MULTILINE)
        text = text.replace("ï½œ", "|") 

        # 4. è¡Œå†æ§‹ç¯‰
        lines = []
        text = text.replace('\r\n', '\n')
        
        for line in text.split('\n'):
            line = line.strip()
            if not line: continue
            
            if line.startswith(('ã€Œ', 'ã€', 'ï¼ˆ', 'ã€', '<', 'ã€ˆ')):
                lines.append("") 
                lines.append(line)
                lines.append("") 
            else:
                lines.append(f"ã€€{line}")
                lines.append("") 

        text = "\n".join(lines)
        text = re.sub(r'\n{3,}', '\n\n', text)

        return text.strip()

# ==========================================
# 1. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç®¡ç†
# ==========================================
class DatabaseManager:
    def __init__(self, db_path):
        self.db_path = db_path
        self.queue = asyncio.Queue()
        self._worker_task = None

    async def start(self):
        self._worker_task = asyncio.create_task(self._worker())
        await self._init_tables_async()

    async def _init_tables_async(self):
        await self.execute('''
                CREATE TABLE IF NOT EXISTS books (
                    id INTEGER PRIMARY KEY AUTOINCREMENT, title TEXT, genre TEXT, concept TEXT,
                    synopsis TEXT, catchcopy TEXT, target_eps INTEGER, style_dna TEXT,
                    target_audience TEXT, special_ability TEXT DEFAULT '',
                    status TEXT DEFAULT 'active', created_at TEXT, marketing_data TEXT, sub_plots TEXT
                );
            ''')
        await self.execute('''
                CREATE TABLE IF NOT EXISTS bible (
                    id INTEGER PRIMARY KEY AUTOINCREMENT, book_id INTEGER, 
                    immutable TEXT, mutable TEXT, revealed TEXT,
                    revealed_mysteries TEXT, pending_foreshadowing TEXT,
                    last_updated TEXT
                );
            ''')
        await self.execute('''
                CREATE TABLE IF NOT EXISTS plot (
                    book_id INTEGER, ep_num INTEGER, title TEXT, summary TEXT,
                    main_event TEXT, sub_event TEXT, pacing_type TEXT,
                    tension INTEGER DEFAULT 50, cliffhanger_score INTEGER DEFAULT 0,
                    status TEXT DEFAULT 'planned', 
                    setup TEXT, conflict TEXT, climax TEXT, resolution TEXT,
                    scenes TEXT,
                    PRIMARY KEY(book_id, ep_num)
                );
            ''')
        await self.execute('''
                CREATE TABLE IF NOT EXISTS chapters (
                    book_id INTEGER, ep_num INTEGER, title TEXT, content TEXT,
                    score_story INTEGER, killer_phrase TEXT, reader_retention_score INTEGER,
                    ending_emotion TEXT, discomfort_score INTEGER DEFAULT 0, tags TEXT,
                    ai_insight TEXT, retention_data TEXT, summary TEXT, world_state TEXT,
                    created_at TEXT, PRIMARY KEY(book_id, ep_num)
                );
            ''')
        await self.execute('''
                CREATE TABLE IF NOT EXISTS characters (
                    id INTEGER PRIMARY KEY AUTOINCREMENT, book_id INTEGER, name TEXT, role TEXT, dna_json TEXT, monologue_style TEXT
                );
            ''')

    async def execute(self, query, params=()):
        future = asyncio.get_running_loop().create_future()
        await self.queue.put((query, params, future))
        return await future

    async def _worker(self):
        conn = sqlite3.connect(self.db_path, check_same_thread=False)
        conn.row_factory = sqlite3.Row
        conn.execute("PRAGMA journal_mode=WAL;")
        while True:
            query, params, future = await self.queue.get()
            try:
                is_write = query.strip().upper().startswith(("INSERT", "UPDATE", "DELETE", "REPLACE", "CREATE"))
                cursor = conn.execute(query, params)
                if is_write:
                    conn.commit()
                    future.set_result(cursor.lastrowid)
                else:
                    future.set_result(None)
                    pass
            except Exception as e:
                future.set_exception(e)
            finally:
                self.queue.task_done()

    async def fetch_all(self, query, params=()):
        def _fetch():
            with sqlite3.connect(self.db_path, check_same_thread=False) as conn:
                conn.row_factory = sqlite3.Row
                return [dict(row) for row in conn.execute(query, params).fetchall()]
        return await asyncio.to_thread(_fetch)
            
    async def fetch_one(self, query, params=()):
        def _fetch():
            with sqlite3.connect(self.db_path, check_same_thread=False) as conn:
                conn.row_factory = sqlite3.Row
                row = conn.execute(query, params).fetchone()
                return dict(row) if row else None
        return await asyncio.to_thread(_fetch)

db = DatabaseManager(DB_FILE)

# ==========================================
# 2. Dynamic Bible System
# ==========================================
class DynamicBibleManager:
    def __init__(self, book_id):
        self.book_id = book_id
    
    async def get_current_state(self) -> WorldState:
        row = await db.fetch_one("SELECT * FROM bible WHERE book_id=? ORDER BY id DESC LIMIT 1", (self.book_id,))
        if not row:
            return WorldState(immutable="{}", mutable="{}", revealed=[], revealed_mysteries=[], pending_foreshadowing=[])
        try:
            return WorldState(
                immutable=row['immutable'] if row['immutable'] else "{}",
                mutable=row['mutable'] if row['mutable'] else "{}",
                revealed=json.loads(row['revealed']) if row['revealed'] else [],
                revealed_mysteries=json.loads(row['revealed_mysteries']) if row.get('revealed_mysteries') else [],
                pending_foreshadowing=json.loads(row['pending_foreshadowing']) if row.get('pending_foreshadowing') else []
            )
        except:
            return WorldState(immutable="{}", mutable="{}", revealed=[], revealed_mysteries=[], pending_foreshadowing=[])

    async def update_state(self, new_state: WorldState):
        await db.execute(
            "INSERT INTO bible (book_id, immutable, mutable, revealed, revealed_mysteries, pending_foreshadowing, last_updated) VALUES (?,?,?,?,?,?,?)",
            (
                self.book_id,
                new_state.immutable, 
                new_state.mutable,    
                json.dumps(new_state.revealed, ensure_ascii=False),
                json.dumps(new_state.revealed_mysteries, ensure_ascii=False),
                json.dumps(new_state.pending_foreshadowing, ensure_ascii=False),
                datetime.datetime.now().isoformat()
            )
        )

    async def get_prompt_context(self) -> str:
        state = await self.get_current_state()
        return f"""
ã€WORLD STATE (Current)ã€‘
[IMMUTABLE]: {state.immutable}
[MUTABLE]: {state.mutable}
[REVEALED]: {json.dumps(state.revealed, ensure_ascii=False)}
[SOLVED MYSTERIES]: {json.dumps(state.revealed_mysteries, ensure_ascii=False)}
[PENDING FORESHADOWING]: {json.dumps(state.pending_foreshadowing, ensure_ascii=False)}
"""

# ==========================================
# 3. Adaptive Rate Limiter
# ==========================================
class AdaptiveRateLimiter:
    def __init__(self, initial_limit=5, min_limit=1):
        self.limit = initial_limit
        self.min_limit = min_limit
        self.semaphore = asyncio.Semaphore(initial_limit)
        self.lock = asyncio.Lock()
    
    async def acquire(self):
        await self.semaphore.acquire()

    def release(self):
        self.semaphore.release()

    async def report_success(self):
        async with self.lock:
            if self.limit < 10: 
                self.limit += 1

    async def report_failure(self):
        async with self.lock:
            old_limit = self.limit
            self.limit = max(self.min_limit, self.limit // 2)
            print(f"ğŸ“‰ Circuit Breaker Triggered: Limit reduced {old_limit} -> {self.limit}")
            await asyncio.sleep(5) 

# ==========================================
# 4. ULTRA Engine (Autopilot)
# ==========================================
class UltraEngine:
    def __init__(self, api_key):
        self.client = genai.Client(api_key=api_key) if api_key else None
        self.rate_limiter = AdaptiveRateLimiter(initial_limit=5)
        self.safety_settings = [
            types.SafetySetting(category="HARM_CATEGORY_HATE_SPEECH", threshold="BLOCK_NONE"),
            types.SafetySetting(category="HARM_CATEGORY_HARASSMENT", threshold="BLOCK_NONE"),
            types.SafetySetting(category="HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold="BLOCK_NONE"),
            types.SafetySetting(category="HARM_CATEGORY_DANGEROUS_CONTENT", threshold="BLOCK_NONE"),
        ]

    def _generate_system_rules(self, mc_profile, style="style_web_standard"):
        p_data = mc_profile.get('pronouns', {})
        k_data = mc_profile.get('keyword_dictionary', {})
        if isinstance(p_data, str):
            try: p_data = json.loads(p_data)
            except: pass
        if isinstance(k_data, str):
            try: k_data = json.loads(k_data)
            except: pass
            
        pronouns_json = json.dumps(p_data, ensure_ascii=False)
        keywords_json = json.dumps(k_data, ensure_ascii=False)
        monologue = mc_profile.get('monologue_style', 'æ¨™æº–')
        
        mc_name = mc_profile.get('name', 'ä¸»äººå…¬')
        mc_tone = mc_profile.get('tone', 'æ¨™æº–')
        mc_personality = mc_profile.get('personality', 'æ¨™æº–')

        style_def = STYLE_DEFINITIONS.get(style, STYLE_DEFINITIONS["style_web_standard"])
        style_sample = STYLE_SAMPLES.get(style, STYLE_SAMPLES["style_web_standard"])

        return PROMPT_TEMPLATES["system_rules"].format(
            mc_name=mc_name,
            mc_tone=mc_tone,
            mc_personality=mc_personality,
            pronouns=pronouns_json, 
            keywords=keywords_json, 
            monologue_style=monologue,
            style_name=style_def["name"],
            style_instruction=style_def["instruction"],
            few_shot_sample=style_sample
        )

    async def _generate_with_retry(self, model, contents, config, retries=10, initial_delay=2.0):
        await self.rate_limiter.acquire()
        try:
            for attempt in range(retries):
                try:
                    response = await self.client.aio.models.generate_content(
                        model=model, 
                        contents=contents, 
                        config=config
                    )
                    await self.rate_limiter.report_success()
                    return response
                except Exception as e:
                    error_str = str(e)
                    is_429 = "429" in error_str or "ResourceExhausted" in error_str
                    
                    if is_429:
                        await self.rate_limiter.report_failure()
                        wait_time = (initial_delay * (2 ** attempt)) + random.uniform(0.5, 1.5)
                        print(f"âš ï¸ Quota Limit. Sleeping {wait_time:.2f}s...")
                        await asyncio.sleep(wait_time)
                    else:
                        print(f"âš ï¸ API Error: {e}. Retrying...")
                        await asyncio.sleep(2)
            raise Exception("Max retries exceeded")
        finally:
            self.rate_limiter.release()

    # ---------------------------------------------------------
    # Core Logic
    # ---------------------------------------------------------

    async def generate_universe_blueprint_phase1(self, genre, style, mc_personality, mc_tone, keywords):
        """ç¬¬1æ®µéš: 1-25è©±ã®ãƒ—ãƒ­ãƒƒãƒˆç”Ÿæˆ (50è©±æ§‹æˆã¸å¤‰æ›´)"""
        print("Step 1: Hyper-Resolution Plot Generation Phase 1 (Ep 1-25)...")
        
        style_name = STYLE_DEFINITIONS.get(style, {"name": style}).get("name")

        prompt = f"""
ã‚ãªãŸã¯Webå°èª¬ã®ç¥ç´šãƒ—ãƒ­ãƒƒãƒˆã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒˆã§ã™ã€‚
ã‚¸ãƒ£ãƒ³ãƒ«ã€Œ{genre}ã€ã§ã€èª­è€…ã‚’ç†±ç‹‚ã•ã›ã‚‹**å…¨50è©±å®Œçµã®ç‰©èªæ§‹é€ **ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼æŒ‡å®šã®çµ¶å¯¾æ¡ä»¶ã€‘
1. æ–‡ä½“: ã€Œ{style_name}ã€
2. ä¸»äººå…¬: æ€§æ ¼{mc_personality}, å£èª¿ã€Œ{mc_tone}ã€
3. ãƒ†ãƒ¼ãƒ: {keywords}

ã€Task: Phase 1 (Ep 1-25)ã€‘
ä½œå“è¨­å®šã¨ã€å‰åŠãƒ‘ãƒ¼ãƒˆã§ã‚ã‚‹**ç¬¬1è©±ã€œç¬¬25è©±**ã®è©³ç´°ãƒ—ãƒ­ãƒƒãƒˆã‚’ä½œæˆã›ã‚ˆã€‚
å‰åŠã®ã‚¯ãƒ©ã‚¤ãƒãƒƒã‚¯ã‚¹ï¼ˆç¬¬25è©±ï¼‰ã«å‘ã‘ã¦ã€ãƒ†ãƒ³ã‚·ãƒ§ãƒ³ã‚’é«˜ã‚ã¦ã„ãã“ã¨ã€‚
æ³¨: mc_profileå†…ã® pronouns ã¨ keyword_dictionary ã¯æœ‰åŠ¹ãªJSONæ–‡å­—åˆ—ã¨ã—ã¦å‡ºåŠ›ã™ã‚‹ã“ã¨ã€‚
"""
        try:
            res = await self._generate_with_retry(
                model=MODEL_ULTRALONG,
                contents=prompt,
                config=types.GenerateContentConfig(
                    response_mime_type="application/json",
                    response_schema=NovelStructure,
                    safety_settings=self.safety_settings
                )
            )
            data = json.loads(res.text)
            
            if 'mc_profile' in data:
                if isinstance(data['mc_profile'].get('pronouns'), str):
                    try: data['mc_profile']['pronouns'] = json.loads(data['mc_profile']['pronouns'])
                    except: data['mc_profile']['pronouns'] = {}
                if isinstance(data['mc_profile'].get('keyword_dictionary'), str):
                    try: data['mc_profile']['keyword_dictionary'] = json.loads(data['mc_profile']['keyword_dictionary'])
                    except: data['mc_profile']['keyword_dictionary'] = {}

            return data
        except Exception as e:
            print(f"Plot Phase 1 Error: {e}")
            return None

    async def generate_universe_blueprint_phase2(self, genre, style, mc_personality, mc_tone, keywords, data1):
        """ç¬¬2æ®µéš: 26-50è©±ã®ãƒ—ãƒ­ãƒƒãƒˆç”Ÿæˆ"""
        print("Step 1 (Parallel): Hyper-Resolution Plot Generation Phase 2 (Ep 26-50)...")
        
        context_summ = "\n".join([f"Ep{p['ep_num']}: {p['resolution'][:50]}..." for p in data1['plots']])
        prompt = f"""
ã‚ãªãŸã¯Webå°èª¬ã®ç¥ç´šãƒ—ãƒ­ãƒƒãƒˆã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒˆã§ã™ã€‚
å…¨50è©±å®Œçµã®ç‰©èªæ§‹é€ ã®å¾ŒåŠã‚’ä½œæˆã—ã¾ã™ã€‚

ã€ã“ã‚Œã¾ã§ã®æµã‚Œ (Ep1-25)ã€‘
{context_summ}

ã€Task: Phase 2 (Ep 26-50)ã€‘
å‰åŠã®ç¶šãã¨ã—ã¦ã€**ç¬¬26è©±ã€œç¬¬50è©±ï¼ˆæœ€çµ‚è©±ï¼‰**ã‚’ä½œæˆã›ã‚ˆã€‚
ç‰©èªã®ä¼ç·šã‚’å›åã—ã€æ„Ÿå‹•çš„ãªãƒ•ã‚£ãƒŠãƒ¼ãƒ¬ã¸å°ãã“ã¨ã€‚
"""
        try:
            res = await self._generate_with_retry(
                model=MODEL_ULTRALONG,
                contents=prompt,
                config=types.GenerateContentConfig(
                    response_mime_type="application/json",
                    response_schema=Phase2Structure,
                    safety_settings=self.safety_settings
                )
            )
            return json.loads(res.text)
        except Exception as e:
            print(f"Plot Phase 2 Error: {e}")
            return None

    async def evaluate_consistency(self, ep_text, bible_manager) -> ConsistencyResult:
        """ãƒ†ã‚­ã‚¹ãƒˆãƒ™ãƒ¼ã‚¹ã®æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯"""
        state = await bible_manager.get_current_state()
        prompt = f"""
ã‚ãªãŸã¯ç‰©èªã®æ•´åˆæ€§ã‚’ç›£æŸ»ã™ã‚‹AIãƒ­ã‚¸ãƒƒã‚¯ã§ã™ã€‚
ä»¥ä¸‹ã®ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰æœ¬æ–‡ã¨ã€ŒBibleï¼ˆä¸–ç•Œè¨­å®šï¼‰ã€ã‚’æ¯”è¼ƒã—ã€çŸ›ç›¾ã‚’æ¤œå‡ºã—ã¦ãã ã•ã„ã€‚

ã€Bibleã€‘
Immutable: {state.immutable}
Mutable: {state.mutable}

ã€Episode Textã€‘
{ep_text[:3000]}... (Excerpt)

åˆ¤å®šåŸºæº–:
1. æ­»ã‚“ã ã¯ãšã®ã‚­ãƒ£ãƒ©ãŒç”Ÿãã¦ã„ãªã„ã‹ï¼Ÿ
2. è¨­å®šã•ã‚ŒãŸç‰©ç†æ³•å‰‡ã‚„èƒ½åŠ›ã«é•åã—ã¦ã„ãªã„ã‹ï¼Ÿ
3. ã‚­ãƒ£ãƒ©ã®å£èª¿ã‚„ä¸€äººç§°ãŒå´©å£Šã—ã¦ã„ãªã„ã‹ï¼Ÿ

é‡å¤§ãªçŸ›ç›¾ãŒã‚ã‚‹å ´åˆã¯ã€ä»¥ä¸‹ã®å½¢å¼ã§å‡ºåŠ›ã›ã‚ˆã€‚çŸ›ç›¾ãŒãªã„å ´åˆã¯ã€ŒSAFEã€ã¨å‡ºåŠ›ã›ã‚ˆã€‚

[DECISION] REWRITE_NEEDED
[REASONS]
- çŸ›ç›¾ç‚¹1
- çŸ›ç›¾ç‚¹2
"""
        try:
            res = await self._generate_with_retry(
                model=MODEL_LITE,
                contents=prompt,
                config=types.GenerateContentConfig(safety_settings=self.safety_settings)
            )
            text = res.text
            is_rewrite = "REWRITE_NEEDED" in text
            reasons = []
            if is_rewrite:
                reasons = re.findall(r"-\s*(.*)", text)
            
            return ConsistencyResult(
                is_consistent=not is_rewrite,
                fatal_errors=reasons,
                minor_errors=[],
                rewrite_needed=is_rewrite
            )
        except Exception as e:
            return ConsistencyResult(is_consistent=True, fatal_errors=[], minor_errors=[], rewrite_needed=False)

    async def sync_with_chapter(self, bible_manager, chapter_text):
        """ãƒ†ã‚­ã‚¹ãƒˆãƒ™ãƒ¼ã‚¹ã®Bibleè‡ªå‹•æ›´æ–°"""
        current = await bible_manager.get_current_state()
        prompt = f"""
ã‚ãªãŸã¯ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç®¡ç†è€…ã§ã™ã€‚
ä»¥ä¸‹ã®ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰æœ¬æ–‡ã‹ã‚‰ã€Œæ–°ãŸã«ç¢ºå®šã—ãŸè¨­å®šã€ã€Œå¤‰åŒ–ã—ãŸã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã€ã€Œèª­è€…ã«é–‹ç¤ºã•ã‚ŒãŸç§˜å¯†ã€ã€Œè§£æ˜ã•ã‚ŒãŸè¬ã€ã€Œæ–°ãŸã«å¼µã‚‰ã‚ŒãŸä¼ç·šã€ã‚’æŠ½å‡ºã—ã€
WorldStateã‚’æ›´æ–°ã—ã¦ãã ã•ã„ã€‚

ã€Current Stateã€‘
Immutable: {current.immutable}
Mutable: {current.mutable}
Pending Foreshadowing: {json.dumps(current.pending_foreshadowing, ensure_ascii=False)}

ã€Episode Textã€‘
{chapter_text[:5000]}

Task:
ä»¥ä¸‹ã®ã‚¿ã‚°å½¢å¼ã§å‡ºåŠ›ã›ã‚ˆã€‚JSONã¯ä½¿ã‚ãšã€ã‚­ãƒ¼ãƒãƒªãƒ¥ãƒ¼å½¢å¼ã®ãƒ†ã‚­ã‚¹ãƒˆã§è¨˜è¿°ã›ã‚ˆã€‚
[IMMUTABLE]
(å¤‰æ›´ãªã—ã€ã¾ãŸã¯æ–°äº‹å®Ÿã®è¿½è¨˜)
[MUTABLE]
(ä½ç½®ã€ç”Ÿæ­»ã€æ‰€æŒå“ã®å¤‰åŒ–)
[REVEALED]
(èª­è€…ã«é–‹ç¤ºã•ã‚ŒãŸè¨­å®šç”¨èªã€ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Š)
[SOLVED]
(å›åã•ã‚ŒãŸä¼ç·šãƒ»è¬ã€ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Š)
[PENDING]
(æ–°ãŸã«æç¤ºã•ã‚ŒãŸè¬ãƒ»ä¼ç·šã€ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Š)
"""
        try:
            res = await self._generate_with_retry(
                model=MODEL_LITE,
                contents=prompt,
                config=types.GenerateContentConfig(safety_settings=self.safety_settings)
            )
            text = res.text
            
            imm_match = re.search(r"\[IMMUTABLE\]\s*(.*?)\s*(?=\[MUTABLE\]|$)", text, re.DOTALL)
            mut_match = re.search(r"\[MUTABLE\]\s*(.*?)\s*(?=\[REVEALED\]|$)", text, re.DOTALL)
            rev_match = re.search(r"\[REVEALED\]\s*(.*?)\s*(?=\[SOLVED\]|$)", text, re.DOTALL)
            sol_match = re.search(r"\[SOLVED\]\s*(.*?)\s*(?=\[PENDING\]|$)", text, re.DOTALL)
            pen_match = re.search(r"\[PENDING\]\s*(.*?)\s*$", text, re.DOTALL)
            
            imm_str = imm_match.group(1).strip() if imm_match else "{}"
            mut_str = mut_match.group(1).strip() if mut_match else "{}"
            rev_str = rev_match.group(1).strip() if rev_match else ""
            sol_str = sol_match.group(1).strip() if sol_match else ""
            pen_str = pen_match.group(1).strip() if pen_match else ""
            
            revealed_list = [x.strip() for x in rev_str.split(',') if x.strip()]
            solved_list = [x.strip() for x in sol_str.split(',') if x.strip()]
            new_pending_list = [x.strip() for x in pen_str.split(',') if x.strip()]
            
            current_pending = current.pending_foreshadowing
            # è§£æ±ºã•ã‚ŒãŸä¼ç·šã‚’å‰Šé™¤
            updated_pending = [p for p in current_pending if p not in solved_list] + new_pending_list
            updated_solved = current.revealed_mysteries + solved_list

            new_state = WorldState(
                immutable=imm_str,
                mutable=mut_str,
                revealed=list(set(current.revealed + revealed_list)),
                revealed_mysteries=list(set(updated_solved)),
                pending_foreshadowing=list(set(updated_pending))
            )
            await bible_manager.update_state(new_state)
            return new_state
        except Exception as e:
            print(f"Bible Sync Error: {e}")
            return current

    async def write_episodes(self, book_data, start_ep, end_ep, style_dna_str="style_web_standard", target_model=MODEL_LITE, rewrite_instruction=None, semaphore=None):
        """
        ã€åŸ·ç­†ã‚¨ãƒ³ã‚¸ãƒ³å¤§è¦æ¨¡æ”¹ä¿®ã€‘ãƒ¯ãƒ³ã‚·ãƒ§ãƒƒãƒˆä¸€æ‹¬ç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯
        """
        
        all_plots = sorted(book_data['plots'], key=lambda x: x.get('ep_num', 999))
        target_plots = [p for p in all_plots if start_ep <= p.get('ep_num', -1) <= end_ep]
        if not target_plots: return None

        full_chapters = []
        bible_manager = DynamicBibleManager(book_data['book_id'])
        
        # å‰è©±ã®æ–‡è„ˆå–å¾—
        prev_ep_row = await db.fetch_one("SELECT content, summary FROM chapters WHERE book_id=? AND ep_num=? ORDER BY ep_num DESC LIMIT 1", (book_data['book_id'], start_ep - 1))
        prev_context_text = prev_ep_row['content'][-500:] if prev_ep_row and prev_ep_row['content'] else "ï¼ˆç‰©èªé–‹å§‹ï¼‰"

        system_rules = self._generate_system_rules(book_data['mc_profile'], style=style_dna_str)
        mc_name = book_data['mc_profile'].get('name', 'ä¸»äººå…¬')
        
        vocab_filter = f"""
ã€Vocal Persona: {mc_name}ã€‘
- çŸ¥è­˜ãƒ¬ãƒ™ãƒ«: ä¸€èˆ¬äººãƒ¬ãƒ™ãƒ«ï¼ˆå°‚é–€ç”¨èªã¯çŸ¥ã‚‰ãªã„ã“ã¨ï¼‰
- ç¦æ­¢èªå½™: {json.dumps(book_data['mc_profile'].get('keyword_dictionary', {}), ensure_ascii=False)} ä»¥å¤–ã®é›£è§£ãªè¨€è‘‰
"""

        for plot in target_plots:
            ep_num = plot['ep_num']
            print(f"Hyper-Narrative Engine Writing Ep {ep_num} (One-Shot Mode)...")
            
            # ãƒ¢ãƒ‡ãƒ«æœ€é©åŒ–ãƒ­ã‚¸ãƒƒã‚¯: 1è©±ã€50è©±ã€é«˜ãƒ†ãƒ³ã‚·ãƒ§ãƒ³å›ã¯PROãƒ¢ãƒ‡ãƒ«ã‚’ä½¿ç”¨
            tension = plot.get('tension', 50)
            current_model = target_model
            if ep_num == 1 or ep_num == 50 or tension >= 80:
                current_model = MODEL_PRO
            
            # ãƒ—ãƒ­ãƒƒãƒˆæƒ…å ±ã®çµåˆ
            episode_plot_text = f"""
ã€Episode Titleã€‘{plot['title']}
ã€Setup (å°å…¥)ã€‘ {plot.get('setup', '')}
ã€Conflict (å±•é–‹)ã€‘ {plot.get('conflict', '')}
ã€Climax (è¦‹ã›å ´)ã€‘ {plot.get('climax', '')}
ã€Resolution (çµæœ«ãƒ»å¼•ã)ã€‘ {plot.get('resolution', '')}
"""
            
            # åŸ·ç­†ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæ§‹ç¯‰
            bible_context = await bible_manager.get_prompt_context()
            world_state = await bible_manager.get_current_state()
            
            write_prompt = f"""
{system_rules}
{vocab_filter}
{PROMPT_TEMPLATES["writing_rules"]}
{PROMPT_TEMPLATES["cliffhanger_protocol"]}

ã€Role: Novelist ({current_model})ã€‘
ä»¥ä¸‹ã®ãƒ—ãƒ­ãƒƒãƒˆã«åŸºã¥ãã€**ç¬¬{ep_num}è©±**ã®æœ¬æ–‡ã‚’ä¸€æ‹¬åŸ·ç­†ã›ã‚ˆã€‚
ç‰¹ã«ã€Pending Foreshadowingã€‘ã«ã‚ã‚‹æœªå›åã®ä¼ç·šã‚’å„ªå…ˆçš„ã«è§£æ¶ˆã™ã‚‹ã‚ˆã†æ„è­˜ã›ã‚ˆã€‚

ã€Pending Foreshadowing (Priority)ã€‘
{json.dumps(world_state.pending_foreshadowing, ensure_ascii=False)}

ã€å‰è©±ã‹ã‚‰ã®æ–‡è„ˆã€‘
...{prev_context_text}

ã€ä»Šå›ã®ãƒ—ãƒ­ãƒƒãƒˆã€‘
{episode_plot_text}

ã€World Context (Bible)ã€‘
{bible_context}

ã€Rewrite Instructionã€‘
{rewrite_instruction if rewrite_instruction else "ãªã—"}
"""
            
            scene_text = ""
            async with semaphore:
                try:
                    res = await self._generate_with_retry(
                        model=current_model, 
                        contents=write_prompt,
                        config=types.GenerateContentConfig(safety_settings=self.safety_settings)
                    )
                    scene_text = res.text
                except Exception as e:
                    print(f"Writing Error Ep{ep_num}: {e}")
                    scene_text = "ï¼ˆç”Ÿæˆã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸï¼‰"

            full_content = scene_text.strip()
            
            # 1. WorldStateã®æ›´æ–°
            new_state = await self.sync_with_chapter(bible_manager, full_content)
            
            # 2. æ¬¡ã®è©±ã®ãŸã‚ã®æ–‡è„ˆè¦ç´„ã‚’ç”Ÿæˆ
            summary_prompt = f"ä»¥ä¸‹ã®ç¬¬{ep_num}è©±ã®å†…å®¹ã‚’300æ–‡å­—ã§è¦ç´„ã›ã‚ˆ:\n{full_content[:5000]}"
            try:
                sum_res = await self._generate_with_retry(model=MODEL_LITE, contents=summary_prompt, config=types.GenerateContentConfig())
                ep_summary = sum_res.text.strip()
            except:
                ep_summary = full_content[-300:]
                
            # 3. ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆæ³¨å…¥ï¼ˆæ¬¡ãƒ«ãƒ¼ãƒ—ç”¨å¤‰æ•°æ›´æ–°ï¼‰
            prev_context_text = f"ï¼ˆç¬¬{ep_num}è©±è¦ç´„ï¼‰{ep_summary}\nï¼ˆç›´è¿‘ã®æ–‡ï¼‰{full_content[-200:]}"

            # ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰å®Œäº†å‡¦ç†
            full_chapters.append({
                "ep_num": ep_num,
                "title": plot['title'],
                "content": full_content,
                "summary": ep_summary,
                "world_state": new_state.model_dump()
            })

        return {"chapters": full_chapters}

    async def _summarize_chunk(self, text_chunk, start_ep, end_ep):
        prompt = f"""
ã€Task: Context Compressionã€‘ ä»¥ä¸‹ã®ç¬¬{start_ep}è©±ã€œç¬¬{end_ep}è©±ã®æœ¬æ–‡ã‚’ã€ç‰©èªã®é‡è¦ãƒã‚¤ãƒ³ãƒˆã‚’æ¼ã‚‰ã•ãš1000æ–‡å­—ç¨‹åº¦ã«ã€Œæ¿ƒç¸®è¦ç´„ã€ã›ã‚ˆã€‚
{text_chunk[:10000]}...
"""
        try:
            res = await self._generate_with_retry(
                model=MODEL_LITE,
                contents=prompt,
                config=types.GenerateContentConfig(safety_settings=self.safety_settings)
            )
            return res.text.strip()
        except Exception as e:
            return text_chunk[:1000]

    async def analyze_and_create_assets(self, book_id):
        """MODEL_MARKETING (Gemini 2.0 Flash Lite) ã‚’ä½¿ç”¨ã—ã¦åˆ†æ"""
        print("Starting Recursive Analysis (Sliding Window)...")
        
        chapters = await db.fetch_all("SELECT ep_num, title, summary, content FROM chapters WHERE book_id=? ORDER BY ep_num", (book_id,))
        book_info = await db.fetch_one("SELECT title FROM books WHERE id=?", (book_id,))
        if not chapters: return [], [], None

        chunk_size = 5
        summary_tasks = []
        for i in range(0, len(chapters), chunk_size):
            chunk = chapters[i : i + chunk_size]
            full_text = "\n".join([f"Ep{c['ep_num']} {c['title']}:\n{c['content']}" for c in chunk])
            summary_tasks.append(self._summarize_chunk(full_text, chunk[0]['ep_num'], chunk[-1]['ep_num']))
        
        compressed_summaries = await asyncio.gather(*summary_tasks)
        master_context = "\n\n".join(compressed_summaries)
        
        prompt = f"""
ã‚ãªãŸã¯Webå°èª¬ã®æ•è…•ç·¨é›†è€…å…¼ãƒãƒ¼ã‚±ã‚¿ãƒ¼ã§ã™ã€‚
ä»¥ä¸‹ã®ã‚¿ã‚¹ã‚¯ã‚’ä¸€æ‹¬å®Ÿè¡Œã—ã€JSONã§å‡ºåŠ›ã›ã‚ˆã€‚
æ³¨: marketing_assets ã¯JSONå½¢å¼ã®æ–‡å­—åˆ—ã¨ã—ã¦å‡ºåŠ›ã™ã‚‹ã“ã¨ã€‚

Task 1: å„è©±ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚° & æ”¹å–„ææ¡ˆ
Task 2: èª­è€…é›¢è„±ãƒªã‚¹ã‚¯ã®äºˆæ¸¬ (retention_score: 0-100)
Task 3: ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°ç´ æç”Ÿæˆ (ã‚­ãƒ£ãƒƒãƒã‚³ãƒ”ãƒ¼ã€ã‚¿ã‚°ã€è¿‘æ³ãƒãƒ¼ãƒˆ)

ã€ä½œå“ã‚¿ã‚¤ãƒˆãƒ«ã€‘{book_info['title']}
ã€ç‰©èªå…¨ä½“ãƒ€ã‚¤ã‚¸ã‚§ã‚¹ãƒˆã€‘
{master_context}
"""
        try:
            res = await self._generate_with_retry(
                model=MODEL_MARKETING,
                contents=prompt,
                config=types.GenerateContentConfig(
                    response_mime_type="application/json",
                    response_schema=MarketingAssets,
                    safety_settings=self.safety_settings
                )
            )
            data = MarketingAssets.model_validate_json(res.text)
            
            marketing_assets_dict = {}
            if data.marketing_assets:
                try: marketing_assets_dict = json.loads(data.marketing_assets)
                except: pass
            
            rewrite_target_eps = []
            evaluations_list = [e.model_dump() for e in data.evaluations]
            
            for evaluation in evaluations_list:
                is_low_quality = evaluation.get('total_score', 0) < 60
                is_high_risk = evaluation.get('retention_score', 100) < 60
                
                if is_low_quality or is_high_risk: 
                       rewrite_target_eps.append(evaluation.get('ep_num'))
                       if is_high_risk:
                           evaluation['improvement_point'] += " ã€ç·Šæ€¥æŒ‡ç¤ºã€‘èª­è€…é›¢è„±ã‚’é˜²ããŸã‚ã€MODEL_PROã‚’ä½¿ç”¨ã—ã¦ã€æ³¢ä¹±ã€ã‚„ã€è¡æ’ƒçš„ãªå±•é–‹ã€ã‚’å¼·åˆ¶çš„ã«æ³¨å…¥ã›ã‚ˆã€‚"
            
            await db.execute("UPDATE books SET marketing_data=? WHERE id=?", (json.dumps(marketing_assets_dict, ensure_ascii=False), book_id))
            
            return evaluations_list, rewrite_target_eps, marketing_assets_dict
            
        except Exception as e:
            print(f"Analysis Error: {e}")
            return [], [], None

    async def rewrite_target_episodes(self, book_data, target_ep_ids, evaluations, style_dna_str="style_web_standard"):
        """ãƒªãƒ©ã‚¤ãƒˆå‡¦ç†"""
        rewritten_count = 0
        semaphore = asyncio.Semaphore(1) 
        eval_map = {e['ep_num']: e for e in evaluations}
        tasks = []
        bible_manager = DynamicBibleManager(book_data['book_id'])

        for ep_id in target_ep_ids:
            chapter_row = await db.fetch_one("SELECT content FROM chapters WHERE book_id=? AND ep_num=?", (book_data['book_id'], ep_id))
            consistency = await self.evaluate_consistency(chapter_row['content'], bible_manager)
            
            eval_data = eval_map.get(ep_id, {})
            
            if not consistency.rewrite_needed and ep_id not in target_ep_ids:
                continue

            instruction = f"ã€ç·¨é›†æŒ‡ç¤ºã€‘\n{eval_data.get('improvement_point', '')}\nçŸ›ç›¾ä¿®æ­£: {','.join(consistency.fatal_errors)}"
            
            tasks.append(self.write_episodes(
                book_data, ep_id, ep_id, 
                style_dna_str=style_dna_str, 
                target_model=MODEL_PRO, 
                rewrite_instruction=instruction,
                semaphore=semaphore
            ))
            
        results = await asyncio.gather(*tasks)
        for res in results:
            if res and 'chapters' in res:
                await self.save_chapters_to_db(book_data['book_id'], res['chapters'])
                rewritten_count += 1
        return rewritten_count

    async def save_blueprint_to_db(self, data, genre, style_dna_str):
        if isinstance(data, dict): data_dict = data
        else: data_dict = data.model_dump()
        
        dna = json.dumps({
            "tone": data_dict['mc_profile']['tone'], 
            "personality": data_dict['mc_profile'].get('personality', ''),
            "style_mode": style_dna_str,
            "pov_type": "ä¸€äººç§°"
        }, ensure_ascii=False)
        
        ability_val = data_dict['mc_profile'].get('ability', '')
        
        bid = await db.execute(
            "INSERT INTO books (title, genre, synopsis, concept, target_eps, style_dna, status, special_ability, created_at) VALUES (?,?,?,?,?,?,?,?,?)",
            (data_dict['title'], genre, data_dict['synopsis'], data_dict['concept'], 50, dna, 'active', ability_val, datetime.datetime.now().isoformat())
        )
        c_dna = json.dumps(data_dict['mc_profile'], ensure_ascii=False)
        monologue_val = data_dict['mc_profile'].get('monologue_style', '')
        await db.execute("INSERT INTO characters (book_id, name, role, dna_json, monologue_style) VALUES (?,?,?,?,?)", (bid, data_dict['mc_profile']['name'], 'ä¸»äººå…¬', c_dna, monologue_val))
        
        await db.execute("INSERT INTO bible (book_id, immutable, mutable, revealed, revealed_mysteries, pending_foreshadowing, last_updated) VALUES (?,?,?,?,?,?,?,?)",
                    (bid, "{}", "{}", "[]", "[]", "[]", datetime.datetime.now().isoformat()))

        saved_plots = []
        for p in data_dict['plots']:
            full_title = f"ç¬¬{p['ep_num']}è©± {p['title']}"
            main_ev = f"{p.get('setup','')}->{p.get('climax','')}"
            scenes_json = json.dumps(p.get('scenes', []), ensure_ascii=False)
            await db.execute(
                """INSERT INTO plot (book_id, ep_num, title, main_event, setup, conflict, climax, resolution, tension, status, scenes)
                   VALUES (?,?,?,?,?,?,?,?,?,?,?)""",
                (bid, p['ep_num'], full_title, main_ev, 
                 p.get('setup'), p.get('conflict'), p.get('climax'), p.get('resolution'), 
                 p.get('tension', 50), 'planned', scenes_json)
            )
            saved_plots.append(p)
        return bid, saved_plots

    async def save_additional_plots_to_db(self, book_id, data_p2):
        saved_plots = []
        for p in data_p2['plots']:
            full_title = f"ç¬¬{p['ep_num']}è©± {p['title']}"
            main_ev = f"{p.get('setup','')}->{p.get('climax','')}"
            scenes_json = json.dumps(p.get('scenes', []), ensure_ascii=False)
            await db.execute(
                """INSERT INTO plot (book_id, ep_num, title, main_event, setup, conflict, climax, resolution, tension, status, scenes)
                   VALUES (?,?,?,?,?,?,?,?,?,?,?)""",
                (book_id, p['ep_num'], full_title, main_ev, 
                 p.get('setup'), p.get('conflict'), p.get('climax'), p.get('resolution'), 
                 p.get('tension', 50), 'planned', scenes_json)
            )
            saved_plots.append(p)
        return saved_plots

    async def save_chapters_to_db(self, book_id, chapters_list):
        count = 0
        if not chapters_list: return 0
        for ch in chapters_list:
            content = TextFormatter.format(ch['content'])
            w_state = json.dumps(ch.get('world_state', {}), ensure_ascii=False) if ch.get('world_state') else ""
            await db.execute(
                """INSERT OR REPLACE INTO chapters (book_id, ep_num, title, content, summary, ai_insight, world_state, created_at)
                   VALUES (?,?,?,?,?,?,?,?)""",
                (book_id, ch['ep_num'], ch.get('title', f"ç¬¬{ch['ep_num']}è©±"), content, ch.get('summary', ''), '', w_state, datetime.datetime.now().isoformat())
            )
            await db.execute("UPDATE plot SET status='completed' WHERE book_id=? AND ep_num=?", (book_id, ch['ep_num']))
            count += 1
        return count

# ==========================================
# Task Functions
# ==========================================
async def task_plot_gen_phase2(engine, bid, genre, style, mc_personality, mc_tone, keywords, data1):
    print(f"Parallel Task: Generating Phase 2 for Book ID {bid}...")
    data2 = await engine.generate_universe_blueprint_phase2(genre, style, mc_personality, mc_tone, keywords, data1)

    if data2 and 'plots' in data2:
        saved_plots_p2 = await engine.save_additional_plots_to_db(bid, data2)
        print(f"Phase 2 Plots Saved ({len(saved_plots_p2)} eps).")
        return data2['plots']
    else:
        print("Phase 2 Generation Failed.")
        return []

async def task_write_batch(engine, bid, start_ep, end_ep):
    book_info = await db.fetch_one("SELECT * FROM books WHERE id=?", (bid,))
    plots = await db.fetch_all("SELECT * FROM plot WHERE book_id=? ORDER BY ep_num", (bid,))
    mc = await db.fetch_one("SELECT * FROM characters WHERE book_id=? AND role='ä¸»äººå…¬'", (bid,))

    try:
        style_dna_json = json.loads(book_info['style_dna'])
        saved_style = style_dna_json.get('style_mode', 'style_web_standard')
    except:
        saved_style = 'style_web_standard'
    mc_profile = json.loads(mc['dna_json']) if mc and mc['dna_json'] else {"name":"ä¸»äººå…¬", "tone":"æ¨™æº–"}
    mc_profile['monologue_style'] = mc.get('monologue_style', '') 

    for p in plots:
        if p.get('scenes'):
            try: p['scenes'] = json.loads(p['scenes'])
            except: pass

    full_data = {"book_id": bid, "title": book_info['title'], "mc_profile": mc_profile, "plots": [dict(p) for p in plots]}
    semaphore = asyncio.Semaphore(3) 

    tasks = []
    print(f"Starting Machine-Gun Parallel Writing (Ep {start_ep} - {end_ep})...")

    target_plots = [p for p in plots if start_ep <= p['ep_num'] <= end_ep]

    for p in target_plots:
        ep_num = p['ep_num']
        tasks.append(engine.write_episodes(
            full_data, 
            ep_num, 
            ep_num, 
            style_dna_str=saved_style, 
            target_model=MODEL_LITE, 
            semaphore=semaphore
        ))

    results = await asyncio.gather(*tasks)

    total_count = 0
    for res_data in results:
        if res_data and 'chapters' in res_data:
            c = await engine.save_chapters_to_db(bid, res_data['chapters'])
            total_count += c
            
    print(f"Batch Done (Ep {start_ep}-{end_ep}). Total Episodes Written: {total_count}")
    return total_count, full_data, saved_style

async def task_analyze_marketing(engine, bid):
    print("Analyzing & Creating Marketing Assets...")
    evals, rewrite_targets, assets = await engine.analyze_and_create_assets(bid)
    return evals, rewrite_targets, assets

async def task_rewrite(engine, full_data, rewrite_targets, evals, saved_style):
    if not rewrite_targets: return 0
    print(f"Rewriting {len(rewrite_targets)} Episodes (Consistency & Quality Check)...")
    c = await engine.rewrite_target_episodes(full_data, rewrite_targets, evals, style_dna_str=saved_style)
    return c

# ==========================================
# 3. Main Logic
# ==========================================
def load_seed():
    style_keys = list(STYLE_DEFINITIONS.keys())
    selected_style = random.choice(style_keys)
    
    if not os.path.exists("story_seeds.json"):
        return {
            "genre": "ç¾ä»£ãƒ€ãƒ³ã‚¸ãƒ§ãƒ³",
            "keywords": "é…ä¿¡, äº‹æ•…, ç„¡åŒ",
            "personality": "å†·é™æ²ˆç€",
            "tone": "ä¿º",
            "hook_text": "é…ä¿¡åˆ‡ã‚Šå¿˜ã‚Œã§ä¸–ç•Œæœ€å¼·ãŒãƒãƒ¬ã‚‹",
            "style": selected_style
        }

    with open("story_seeds.json", "r", encoding='utf-8') as f:
        data = json.load(f)
        seed = random.choice(data['seeds'])
        tmpl = random.choice(seed['templates'])
        twists = ["è¨˜æ†¶å–ªå¤±", "å®Ÿã¯2å‘¨ç›®", "ç›¸æ£’ãŒãƒ©ã‚¹ãƒœã‚¹", "å¯¿å‘½ãŒæ®‹ã‚Šã‚ãšã‹"]
        twist = random.choice(twists)
        
        print(f"â˜… Selected: {seed['genre']} - {tmpl['type']} (Style: {STYLE_DEFINITIONS[selected_style]['name']})")
        return {
            "genre": seed['genre'],
            "keywords": f"{tmpl['keywords']}, {twist}",
            "personality": tmpl['mc_profile'],
            "tone": "ä¿º",
            "hook_text": tmpl['hook'],
            "style": selected_style
        }

async def create_zip_package(book_id, title, marketing_data):
    print("Packing ZIP...")
    buffer = io.BytesIO()

    current_book = await db.fetch_one("SELECT * FROM books WHERE id=?", (book_id,))
    db_chars = await db.fetch_all("SELECT * FROM characters WHERE book_id=?", (book_id,))
    db_plots = await db.fetch_all("SELECT * FROM plot WHERE book_id=? ORDER BY ep_num", (book_id,))
    chapters = await db.fetch_all("SELECT * FROM chapters WHERE book_id=? ORDER BY ep_num", (book_id,))

    def clean_filename_title(t):
        return re.sub(r'[\\/:*?"<>|]', '', re.sub(r'^ç¬¬\d+è©±[\sã€€]*', '', t)).strip()

    keyword_dict = {}
    mc_char = next((c for c in db_chars if c['role'] == 'ä¸»äººå…¬'), None)
    if mc_char:
        try:
            dna = json.loads(mc_char['dna_json'])
            keyword_dict = dna.get('keyword_dictionary', {})
            if isinstance(keyword_dict, str):
                keyword_dict = json.loads(keyword_dict)
        except: pass

    with zipfile.ZipFile(buffer, "w", zipfile.ZIP_DEFLATED) as z:
        reg_info = f"ã€ã‚¿ã‚¤ãƒˆãƒ«ã€‘\n{title}\n\nã€ã‚ã‚‰ã™ã˜ã€‘\n{current_book.get('synopsis', '')}\n"
        z.writestr("00_ä½œå“ç™»éŒ²ç”¨ãƒ‡ãƒ¼ã‚¿.txt", reg_info)

        setting_txt = f"ã€ä¸–ç•Œè¦³ãƒ»ç‰¹æ®Šèƒ½åŠ›è¨­å®šã€‘\n{current_book.get('special_ability', 'ãªã—')}\n\n"
        setting_txt += "ã€ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¨­å®šã€‘\n"
        for char in db_chars:
            setting_txt += f"â–  {char['name']} ({char['role']})\n"
            if char.get('monologue_style'):
                setting_txt += f"  - ãƒ¢ãƒãƒ­ãƒ¼ã‚°ç™–: {char['monologue_style']}\n"
            try:
                dna = json.loads(char['dna_json'])
                for k, v in dna.items():
                    if k not in ['name', 'role', 'monologue_style']:
                        val_str = json.dumps(v, ensure_ascii=False) if isinstance(v, (dict, list)) else str(v)
                        setting_txt += f"  - {k}: {val_str}\n"
            except:
                setting_txt += f"  - è¨­å®šãƒ‡ãƒ¼ã‚¿: {char['dna_json']}\n"
            setting_txt += "\n"
        z.writestr("00_ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒ»ä¸–ç•Œè¦³è¨­å®šè³‡æ–™.txt", setting_txt)

        plot_txt = f"ã€ã‚¿ã‚¤ãƒˆãƒ«ã€‘{title}\nã€å…¨è©±ãƒ—ãƒ­ãƒƒãƒˆæ§‹æˆæ¡ˆã€‘\n\n"
        for p in db_plots:
            plot_txt += f"--------------------------------------------------\n"
            plot_txt += f"ç¬¬{p['ep_num']}è©±ï¼š{p['title']}\n"
            plot_txt += f"--------------------------------------------------\n"
            plot_txt += f"ãƒ»ãƒ¡ã‚¤ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆ: {p.get('main_event', '')}\n"
            plot_txt += f"ãƒ»å°å…¥ (Setup): {p.get('setup', '')}\n"
            plot_txt += f"ãƒ»å±•é–‹ (Conflict): {p.get('conflict', '')}\n"
            plot_txt += f"ãƒ»è¦‹ã›å ´ (Climax): {p.get('climax', '')}\n"
            plot_txt += f"ãƒ»çµæœ« (Resolution): {p.get('resolution', '')}\n"
            plot_txt += f"ãƒ»ãƒ†ãƒ³ã‚·ãƒ§ãƒ³: {p.get('tension', '-')}/100\n\n"
        z.writestr("00_å…¨è©±ãƒ—ãƒ­ãƒƒãƒˆæ§‹æˆæ¡ˆ.txt", plot_txt)

        for ch in chapters:
            clean_title = clean_filename_title(ch['title'])
            fname = f"chapters/{ch['ep_num']:02d}_{clean_title}.txt"
            body = TextFormatter.format(ch['content'], k_dict=keyword_dict)
            z.writestr(fname, body)
        
        if marketing_data:
            kinkyo = marketing_data.get('kinkyo_note', '')
            if kinkyo:
                z.writestr("00_è¿‘æ³ãƒãƒ¼ãƒˆ.txt", kinkyo)
            
            meta = f"ã€ã‚¿ã‚¤ãƒˆãƒ«ã€‘\n{title}\n\n"
            meta += f"ã€ã‚­ãƒ£ãƒƒãƒã‚³ãƒ”ãƒ¼ã€‘\n" + "\n".join(marketing_data.get('catchcopies', [])) + "\n\n"
            meta += f"ã€æ¤œç´¢ã‚¿ã‚°ã€‘\n{' '.join(marketing_data.get('tags', []))}\n\n"
            z.writestr("marketing_assets.txt", meta)
            
            try:
                z.writestr("marketing_raw.json", json.dumps(marketing_data, ensure_ascii=False))
            except: pass

    buffer.seek(0)
    return buffer.getvalue()

def send_email(zip_data, title):
    if not GMAIL_USER or not GMAIL_PASS:
        print("Skipping Email: Credentials not found.")
        return

    print(f"Sending Email to {TARGET_EMAIL}...")
    msg = MIMEMultipart()
    msg['Subject'] = f"ã€AI Novel Factoryã€‘{title} (Completed)"
    msg['From'] = GMAIL_USER
    msg['To'] = TARGET_EMAIL

    part = MIMEBase('application', 'zip')
    part.set_payload(zip_data)
    encoders.encode_base64(part)
    clean_title = re.sub(r'[\\/:*?"<>|]', '', title)
    part.add_header('Content-Disposition', f'attachment; filename="{clean_title}.zip"')
    msg.attach(part)

    try:
        with smtplib.SMTP_SSL("smtp.gmail.com", 465) as server:
            server.login(GMAIL_USER, GMAIL_PASS)
            server.send_message(msg)
        print("Email Sent Successfully!")
    except Exception as e:
        print(f"Email Failed: {e}")

async def main():
    if not API_KEY:
        print("Error: GEMINI_API_KEY is missing.")
        return

    await db.start() # Database Worker Start
    engine = UltraEngine(API_KEY)

    print("Starting Factory Pipeline (Async / One-Shot Mode)...")

    try:
        seed = load_seed()
        
        # Step 1: 1-25è©±ãƒ—ãƒ­ãƒƒãƒˆ
        print("Step 1a: Generating Plot Phase 1 (Ep 1-25)...")
        data1 = await engine.generate_universe_blueprint_phase1(
            seed['genre'], seed['style'], seed['personality'], seed['tone'], seed['keywords']
        )
        
        if not data1: 
            print("Plot Gen Phase 1 failed.")
            return

        bid, plots_p1 = await engine.save_blueprint_to_db(data1, seed['genre'], seed['style'])
        print(f"Phase 1 Saved. ID: {bid}")
        
        print("Step 2: Starting Parallel Execution (Write P1 vs Gen P2)...")
        
        # Phase 1 åŸ·ç­† (1-25è©±)
        task_write_p1 = asyncio.create_task(
            task_write_batch(engine, bid, start_ep=1, end_ep=25)
        )
        
        # Phase 2 ãƒ—ãƒ­ãƒƒãƒˆç”Ÿæˆ (26-50è©±)
        task_gen_p2 = asyncio.create_task(
            task_plot_gen_phase2(
                engine, bid, seed['genre'], seed['style'], seed['personality'], seed['tone'], seed['keywords'], data1
            )
        )
        
        count_p1, full_data_p1, saved_style = await task_write_p1
        await task_gen_p2
        
        print("Parallel Execution Completed. Proceeding to Write Phase 2 (Ep 26-50)...")

        # Phase 2 åŸ·ç­† (26-50è©±)
        count_p2, full_data_final, _ = await task_write_batch(engine, bid, start_ep=26, end_ep=50)
        
        full_data = full_data_final 

        evals, rewrite_targets, assets = await task_analyze_marketing(engine, bid)
        print(f"Rewriting Targets (Consistency & Low Score): {rewrite_targets}")

        if rewrite_targets:
            await task_rewrite(engine, full_data, rewrite_targets, evals, saved_style)

        book_info = await db.fetch_one("SELECT title FROM books WHERE id=?", (bid,))
        title = book_info['title']
        
        zip_bytes = await create_zip_package(bid, title, assets)
        send_email(zip_bytes, title)
        print(f"Mission Complete: {title}. System shutting down.")
        
    except Exception as e:
        print(f"Pipeline Critical Error: {e}")
        import traceback
        traceback.print_exc()

if __name__ == "__main__":
    asyncio.run(main())